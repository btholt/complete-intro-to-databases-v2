<!DOCTYPE html><html><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="width=device-width" data-next-head=""/><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png" data-next-head=""/><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png" data-next-head=""/><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png" data-next-head=""/><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png" data-next-head=""/><link rel="icon" type="image/x-icon" href="/images/favicon.ico" data-next-head=""/><title data-next-head="">Complex Neo4j Queries – Complete Intro to Databases v2</title><meta name="description" content="Graph databases are great when you need to define relations between objects that can have complex webs of relations especially for things like social networks." data-next-head=""/><meta name="keywords" content="postgres,sql,redis,mongodb,neo4j,database,data,agents" data-next-head=""/><meta name="og:description" content="Graph databases are great when you need to define relations between objects that can have complex webs of relations especially for things like social networks." data-next-head=""/><meta name="og:title" content="Complex Neo4j Queries – Complete Intro to Databases v2" data-next-head=""/><meta name="og:image" content="/images/social-share-cover.jpg" data-next-head=""/><meta name="twitter:card" content="summary_large_image" data-next-head=""/><link data-next-font="size-adjust" rel="preconnect" href="/" crossorigin="anonymous"/><link rel="preload" href="/_next/static/chunks/3802a39ca373f962.css" as="style"/><link rel="stylesheet" href="/_next/static/chunks/3802a39ca373f962.css" data-n-g=""/><noscript data-n-css=""></noscript><script src="/_next/static/chunks/dbe15a90055bd265.js" defer=""></script><script src="/_next/static/chunks/49c75c2ed6206f46.js" defer=""></script><script src="/_next/static/chunks/da0ff8adaa6cce90.js" defer=""></script><script src="/_next/static/chunks/turbopack-342361b32f83e6b6.js" defer=""></script><script src="/_next/static/chunks/f189af6b04c7fd39.js" defer=""></script><script src="/_next/static/chunks/turbopack-8b35dea75ba6f85c.js" defer=""></script><script src="/_next/static/Ogv8p-BwCHRQ1PzRpAU9u/_ssgManifest.js" defer=""></script><script src="/_next/static/Ogv8p-BwCHRQ1PzRpAU9u/_buildManifest.js" defer=""></script></head><body><script async="" defer="" src="https://a.holt.courses/latest.js"></script><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"/><div id="__next"><link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&amp;display=swap" rel="stylesheet"/><div class="remix-app"><header class="navbar"><h1 class="navbar-brand"><a href="/">Complete Intro to Databases v2</a></h1><div class="navbar-info"><a href="https://frontendmasters.com/workshops/databases-v2/" class="cta-btn">Watch on Frontend Masters</a></div></header><div class="content-container"><div class="main"><div class="lesson-container"><div class="lesson"><div class="lesson-content"><p>This section assumes you&#39;ve inserted all the people and movies from the previous section. If not, <a href="https://btholt.github.io/complete-intro-to-databases/sample-neo4j.cql">run this query</a> to get all the data.</p>
<p>Let&#39;s do some queries to familiarize ourselves with the data.</p>
<pre><code class="hljs language-cql">MATCH (n) RETURN distinct labels(n), count(*);
</code></pre><p>This will query the database for all nodes (which is the <code>(n)</code> part, notice no label) and then it uses the builtin <code>labels()</code> function to get all the labels, and then counts those with <code>count(*)</code> function.</p>
<pre><code class="hljs language-cql">MATCH (n)-[r]-&gt;() RETURN type(r), count(*);
</code></pre><p>Similar to above, we are now counting how many relationships we have in a database.</p>
<p>Okay, so let&#39;s pick an actor or actress and find out what other people they&#39;ve been in movies with. I&#39;ll pick Keanu Reeves here.</p>
<pre><code class="hljs language-cql">MATCH (Keanu:Person)-[:ACTED_IN]-&gt;(m:Movie)&lt;-[:ACTED_IN]-(Costar:Person)
WHERE Keanu.name = &quot;Keanu Reeves&quot;
RETURN DISTINCT Costar.name, count(*)
ORDER BY count(*) DESC, Costar.name;
</code></pre><ul>
<li>We&#39;ve seen similar queries before as far as the MATCH goes.</li>
<li>Similar to above we&#39;re using a DISTINCT clause and then using <code>count(*)</code> to aggregate how many movies Keanu appeared in these movies with these people in.</li>
<li>ORDER BY should look familiar as it works very similar to PostgreSQL. I gave it two fields to order by so it&#39;ll order first by quantity of films they&#39;re in together then alphabetical by name.</li>
</ul>
<p>If you&#39;re using the browser and you want to see a pretty graph, try this:</p>
<pre><code class="hljs language-cql">MATCH (Keanu:Person)-[:ACTED_IN]-&gt;(m:Movie)&lt;-[r:ACTED_IN]-(Costar:Person)
WHERE Keanu.name = &quot;Keanu Reeves&quot;
RETURN Costar, m, Keanu;
</code></pre><p>If you want the nice graphics you need to return whole nodes and not just fields.</p>
<h2>Degrees of Kevin Bacon</h2>
<p>So the whole point of this dataset is to solve the <a href="https://en.wikipedia.org/wiki/Six_Degrees_of_Kevin_Bacon">Six Degrees of Kevin Bacon</a> problem i.e. every actor and actress in Hollywood can be connected Kevin Bacon via them having acted in a film that acted in a film with him directly, with someone who was in a film with Kevin Bacon, or with someone who acted in a film with someone who was in a film with Kevin Bacon, and so-on-and-so-forth up to six degrees of separation.</p>
<p>So let&#39;s see how you could solve that problem with our dataset. Let&#39;s see how close Keanu is. (run this in the browser)</p>
<pre><code class="hljs language-cql">MATCH path = shortestPath(
  (Bacon:Person {name:&quot;Kevin Bacon&quot;})-[*]-(Keanu:Person {name:&quot;Keanu Reeves&quot;})
)
RETURN path;
</code></pre><ul>
<li><code>shortestPath</code> is a function that will find the shortest path between two nodes by looking at their relationships.</li>
<li>The variable <code>path</code> ends up being a path type. It contains all the information for a whole path within your grasp.</li>
<li>You can run this in cypher-shell but it&#39;ll give you a lot of data back.</li>
</ul>
<p>For something more friendly to see in cypher-shell, just look at the length</p>
<pre><code class="hljs language-cql">MATCH path = shortestPath(
  (Bacon:Person {name:&quot;Kevin Bacon&quot;})-[*]-(Keanu:Person {name:&quot;Keanu Reeves&quot;})
)
RETURN length(path);
</code></pre><p>To unwind this in a way that would be readable in cypher-shell with all the movies and actors/actresses you could do this:</p>
<pre><code class="hljs language-cql">MATCH path = shortestPath(
    (First:Person {name:&quot;Kevin Bacon&quot;})-[*]-(Second:Person {name:&quot;Keanu Reeves&quot;})
)
UNWIND nodes(path) AS node
RETURN coalesce(node.name, node.title) AS text;
</code></pre><ul>
<li>UNWIND takes something not a list and makes it a list. With <code>nodes(path)</code> we&#39;re getting all the nodes out (which will be Persons and Movies)</li>
<li><code>coalesce</code> is necessary because Persons have names and Movies have titles. This will take the first thing in there that&#39;s not null.</li>
<li>We use AS here to make these things easier to refer to later (both <code>node</code> and <code>text</code>)</li>
</ul>
<h2>Find Degrees in a Network</h2>
<p>You could imagine if this was a recommendation engine, you may want to recommend people other actors and actresses based on movies people have appeared in together. What if we wanted to take that two degrees out?</p>
<pre><code class="hljs language-cql">MATCH (Halle:Person)-[:ACTED_IN*1..4]-(Recommendation:Person)
WHERE Halle.name = &quot;Halle Berry&quot;
RETURN DISTINCT Recommendation.name
ORDER BY Recommendation.name;
</code></pre><p>This will give you that extended network of people to check out. If you wanted to include diretory and writers in that count, just omit the <code>:ACTED_IN</code> so it&#39;s <code>-[*1..4]-</code> and that will give you any relationship.</p>
</div><div class="lesson-links"><a class="prev" href="/lessons/graph/neo4j-browser">← Previous</a><a class="next" href="/lessons/graph/indexes-in-neo4j">Next →</a></div></div><div class="details-bg"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="154" height="154" viewBox="0 0 154 154"><defs><clipPath id="clip-path"><rect id="Rectangle_2238" data-name="Rectangle 2238" width="154" height="154" transform="translate(9467 350)" fill="#fff" stroke="#707070" stroke-width="1"></rect></clipPath><clipPath id="clip-corner-image-active"><rect width="154" height="154"></rect></clipPath></defs><g id="corner-image-active" clip-path="url(#clip-corner-image-active)"><g id="Corner-image-active-2" data-name="Corner-image-active" transform="translate(-9467 -350)" clip-path="url(#clip-path)"><path id="Subtraction_34" data-name="Subtraction 34" d="M-3857.365,1740.766h0l-7.07-7.07,12.89-12.89v14.142l-5.818,5.818Zm-14.142-14.142h0l-7.071-7.07,27.033-27.033v14.143l-19.96,19.96Zm-14.143-14.143h0l-7.07-7.069,41.175-41.175v14.142Zm-14.142-14.142h0l-7.07-7.069,55.317-55.317v14.142Zm-14.142-14.142h0l-7.07-7.069,69.459-69.459v14.142Zm-14.142-14.142h0l-7.07-7.069,76.739-76.739h6.862v7.28Zm-14.143-14.143h0l-7.07-7.069,62.6-62.6h14.142Zm-14.142-14.142h0l-7.07-7.069,48.454-48.454h14.142Zm-14.142-14.142h0l-7.07-7.069,34.312-34.312h14.142Zm-14.142-14.142h0l-7.07-7.069,20.17-20.17h14.142Zm-14.142-14.142h0l-7.071-7.071,6.027-6.027h14.144l-13.1,13.1Zm367.24-56.114v-.909l.455.455-.453.453Z" transform="translate(13472.546 -1236.766)" fill="var(--corner-fill)"></path></g></g></svg></div></div></div></div><footer class="footer"><ul class="socials"><li class="social"><a href="https://twitter.com/holtbt"><svg fill="none" height="100%" width="32" xmlns="http://www.w3.org/2000/svg" viewBox="0.254 0.25 500 451.95400000000006"><path d="M394.033.25h76.67L303.202 191.693l197.052 260.511h-154.29L225.118 294.205 86.844 452.204H10.127l179.16-204.77L.254.25H158.46l109.234 144.417zm-26.908 406.063h42.483L135.377 43.73h-45.59z" fill="var(--footer-icons)"></path></svg></a></li><li class="social"><a href="https://bsky.app/profile/brianholt.me"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -3.268 64 68.414" width="38" height="100%"><path fill="var(--footer-icons)" d="M13.873 3.805C21.21 9.332 29.103 20.537 32 26.55v15.882c0-.338-.13.044-.41.867-1.512 4.456-7.418 21.847-20.923 7.944-7.111-7.32-3.819-14.64 9.125-16.85-7.405 1.264-15.73-.825-18.014-9.015C1.12 23.022 0 8.51 0 6.55 0-3.268 8.579-.182 13.873 3.805zm36.254 0C42.79 9.332 34.897 20.537 32 26.55v15.882c0-.338.13.044.41.867 1.512 4.456 7.418 21.847 20.923 7.944 7.111-7.32 3.819-14.64-9.125-16.85 7.405 1.264 15.73-.825 18.014-9.015C62.88 23.022 64 8.51 64 6.55c0-9.818-8.578-6.732-13.873-2.745z"></path></svg></a></li><li class="social"><a href="https://github.com/btholt"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 32 32"><defs><clipPath id="clip-github-social"><rect width="32" height="32"></rect></clipPath></defs><g id="github-social" clip-path="url(#clip-github-social)"><g id="Group_272" data-name="Group 272" transform="translate(13522.5 -6994)"><path id="Subtraction_33" data-name="Subtraction 33" d="M-24967.5,8041a15.9,15.9,0,0,1-11.312-4.688A15.893,15.893,0,0,1-24983.5,8025a15.893,15.893,0,0,1,4.689-11.315A15.894,15.894,0,0,1-24967.5,8009a15.894,15.894,0,0,1,11.313,4.686A15.893,15.893,0,0,1-24951.5,8025a15.893,15.893,0,0,1-4.689,11.313A15.9,15.9,0,0,1-24967.5,8041Zm-3.781-4.571h0v3.918h7.895v-6.665a1.836,1.836,0,0,0-1.2-1.718c5.1-.617,7.467-2.975,7.467-7.424a7.176,7.176,0,0,0-1.637-4.728,6.74,6.74,0,0,0,.275-1.812,4.34,4.34,0,0,0-.52-2.452.574.574,0,0,0-.359-.1c-1.061,0-3.465,1.411-3.936,1.694a16.644,16.644,0,0,0-4.2-.489,16.379,16.379,0,0,0-3.969.445c-.846-.5-2.91-1.649-3.859-1.649a.566.566,0,0,0-.354.095,4.3,4.3,0,0,0-.521,2.452,6.7,6.7,0,0,0,.244,1.718,7.346,7.346,0,0,0-1.6,4.822,7.263,7.263,0,0,0,1.533,4.985c1.193,1.359,3.115,2.165,5.871,2.464a1.826,1.826,0,0,0-1.129,1.693v.5h0l-.006,0a7.121,7.121,0,0,1-2.033.363,2.608,2.608,0,0,1-.965-.158,4.438,4.438,0,0,1-1.836-1.881,2.361,2.361,0,0,0-1.248-1.091,3.472,3.472,0,0,0-1.217-.3.584.584,0,0,0-.545.224.282.282,0,0,0,.027.367,1.875,1.875,0,0,0,.447.307,4.732,4.732,0,0,1,.561.355,10.726,10.726,0,0,1,1.682,2.755c.043.092.078.163.105.217a3.876,3.876,0,0,0,2.42,1.185,6.036,6.036,0,0,0,.607.025c.875,0,1.988-.124,2-.125Z" transform="translate(11461 -1015)" fill="var(--footer-icons)"></path><g id="Ellipse_670" data-name="Ellipse 670" transform="translate(-13522.5 6994)" fill="none" stroke="var(--footer-icons)" stroke-width="1"><circle cx="16" cy="16" r="16" stroke="none"></circle><circle cx="16" cy="16" r="15.5" fill="none"></circle></g></g></g></svg></a></li><li class="social"><a href="https://linkedin.com/in/btholt"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 32 32"><defs><clipPath id="clip-linkedin-social"><rect width="32" height="32"></rect></clipPath></defs><g id="linkedin-social" clip-path="url(#clip-linkedin-social)"><g id="Group_270" data-name="Group 270" transform="translate(-86.349 -633.073)"><path id="Path_375" data-name="Path 375" d="M115.789,633.073a2.324,2.324,0,0,1,1.682.676,2.194,2.194,0,0,1,.695,1.627V662.8a2.131,2.131,0,0,1-.695,1.609,2.314,2.314,0,0,1-1.646.659H88.69a2.307,2.307,0,0,1-1.646-.659,2.128,2.128,0,0,1-.695-1.609V635.376a2.19,2.19,0,0,1,.695-1.627,2.322,2.322,0,0,1,1.682-.676h27.063Zm-20.224,9.672a2.561,2.561,0,0,0,0-3.584,2.658,2.658,0,0,0-1.938-.712,2.724,2.724,0,0,0-1.957.712,2.371,2.371,0,0,0-.75,1.792,2.4,2.4,0,0,0,.731,1.792,2.605,2.605,0,0,0,1.9.713h.037A2.7,2.7,0,0,0,95.565,642.745ZM96,645.434H91.213V659.88H96Zm17.3,6.144a7.007,7.007,0,0,0-1.573-4.9,5.68,5.68,0,0,0-6.839-.769,5.663,5.663,0,0,0-1.426,1.573v-2.048H98.674q.036.841,0,7.717v6.728h4.791V651.8a3.592,3.592,0,0,1,.146-1.17,2.913,2.913,0,0,1,.878-1.206,2.429,2.429,0,0,1,1.609-.549,2.108,2.108,0,0,1,1.865.914,4.265,4.265,0,0,1,.549,2.341v7.752H113.3Z" fill="var(--footer-icons)"></path></g></g></svg></a></li><li class="social"><div class="terms"><p>Content Licensed Under CC-BY-NC-4.0</p><p>Code Samples and Exercises Licensed Under Apache 2.0</p><p>Site Designed by<!-- --> <a href="https://www.alexdanielson.com/">Alex Danielson</a></p></div></li></ul><div class="theme-icons"><button aria-label="Activate dark mode" title="Activate dark mode" class="theme-toggle"><svg xmlns="http://www.w3.org/2000/svg" width="36px" height="100%" viewBox="0 -960 960 960" fill="var(--text-footer)" role="img"><title>Dark Mode Icon</title><path d="M480-120q-150 0-255-105T120-480q0-150 105-255t255-105q14 0 27.5 1t26.5 3q-41 29-65.5 75.5T444-660q0 90 63 153t153 63q55 0 101-24.5t75-65.5q2 13 3 26.5t1 27.5q0 150-105 255T480-120Zm0-80q88 0 158-48.5T740-375q-20 5-40 8t-40 3q-123 0-209.5-86.5T364-660q0-20 3-40t8-40q-78 32-126.5 102T200-480q0 116 82 198t198 82Z"></path></svg></button></div></footer></div><noscript><img src="https://a.holt.courses/noscript.gif" alt="" referrerPolicy="no-referrer-when-downgrade"/></noscript></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"attributes":{"description":"Graph databases are great when you need to define relations between objects that can have complex webs of relations especially for things like social networks."},"html":"\u003cp\u003eThis section assumes you\u0026#39;ve inserted all the people and movies from the previous section. If not, \u003ca href=\"https://btholt.github.io/complete-intro-to-databases/sample-neo4j.cql\"\u003erun this query\u003c/a\u003e to get all the data.\u003c/p\u003e\n\u003cp\u003eLet\u0026#39;s do some queries to familiarize ourselves with the data.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-cql\"\u003eMATCH (n) RETURN distinct labels(n), count(*);\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThis will query the database for all nodes (which is the \u003ccode\u003e(n)\u003c/code\u003e part, notice no label) and then it uses the builtin \u003ccode\u003elabels()\u003c/code\u003e function to get all the labels, and then counts those with \u003ccode\u003ecount(*)\u003c/code\u003e function.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-cql\"\u003eMATCH (n)-[r]-\u0026gt;() RETURN type(r), count(*);\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eSimilar to above, we are now counting how many relationships we have in a database.\u003c/p\u003e\n\u003cp\u003eOkay, so let\u0026#39;s pick an actor or actress and find out what other people they\u0026#39;ve been in movies with. I\u0026#39;ll pick Keanu Reeves here.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-cql\"\u003eMATCH (Keanu:Person)-[:ACTED_IN]-\u0026gt;(m:Movie)\u0026lt;-[:ACTED_IN]-(Costar:Person)\nWHERE Keanu.name = \u0026quot;Keanu Reeves\u0026quot;\nRETURN DISTINCT Costar.name, count(*)\nORDER BY count(*) DESC, Costar.name;\n\u003c/code\u003e\u003c/pre\u003e\u003cul\u003e\n\u003cli\u003eWe\u0026#39;ve seen similar queries before as far as the MATCH goes.\u003c/li\u003e\n\u003cli\u003eSimilar to above we\u0026#39;re using a DISTINCT clause and then using \u003ccode\u003ecount(*)\u003c/code\u003e to aggregate how many movies Keanu appeared in these movies with these people in.\u003c/li\u003e\n\u003cli\u003eORDER BY should look familiar as it works very similar to PostgreSQL. I gave it two fields to order by so it\u0026#39;ll order first by quantity of films they\u0026#39;re in together then alphabetical by name.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eIf you\u0026#39;re using the browser and you want to see a pretty graph, try this:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-cql\"\u003eMATCH (Keanu:Person)-[:ACTED_IN]-\u0026gt;(m:Movie)\u0026lt;-[r:ACTED_IN]-(Costar:Person)\nWHERE Keanu.name = \u0026quot;Keanu Reeves\u0026quot;\nRETURN Costar, m, Keanu;\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eIf you want the nice graphics you need to return whole nodes and not just fields.\u003c/p\u003e\n\u003ch2\u003eDegrees of Kevin Bacon\u003c/h2\u003e\n\u003cp\u003eSo the whole point of this dataset is to solve the \u003ca href=\"https://en.wikipedia.org/wiki/Six_Degrees_of_Kevin_Bacon\"\u003eSix Degrees of Kevin Bacon\u003c/a\u003e problem i.e. every actor and actress in Hollywood can be connected Kevin Bacon via them having acted in a film that acted in a film with him directly, with someone who was in a film with Kevin Bacon, or with someone who acted in a film with someone who was in a film with Kevin Bacon, and so-on-and-so-forth up to six degrees of separation.\u003c/p\u003e\n\u003cp\u003eSo let\u0026#39;s see how you could solve that problem with our dataset. Let\u0026#39;s see how close Keanu is. (run this in the browser)\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-cql\"\u003eMATCH path = shortestPath(\n  (Bacon:Person {name:\u0026quot;Kevin Bacon\u0026quot;})-[*]-(Keanu:Person {name:\u0026quot;Keanu Reeves\u0026quot;})\n)\nRETURN path;\n\u003c/code\u003e\u003c/pre\u003e\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eshortestPath\u003c/code\u003e is a function that will find the shortest path between two nodes by looking at their relationships.\u003c/li\u003e\n\u003cli\u003eThe variable \u003ccode\u003epath\u003c/code\u003e ends up being a path type. It contains all the information for a whole path within your grasp.\u003c/li\u003e\n\u003cli\u003eYou can run this in cypher-shell but it\u0026#39;ll give you a lot of data back.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eFor something more friendly to see in cypher-shell, just look at the length\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-cql\"\u003eMATCH path = shortestPath(\n  (Bacon:Person {name:\u0026quot;Kevin Bacon\u0026quot;})-[*]-(Keanu:Person {name:\u0026quot;Keanu Reeves\u0026quot;})\n)\nRETURN length(path);\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eTo unwind this in a way that would be readable in cypher-shell with all the movies and actors/actresses you could do this:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-cql\"\u003eMATCH path = shortestPath(\n    (First:Person {name:\u0026quot;Kevin Bacon\u0026quot;})-[*]-(Second:Person {name:\u0026quot;Keanu Reeves\u0026quot;})\n)\nUNWIND nodes(path) AS node\nRETURN coalesce(node.name, node.title) AS text;\n\u003c/code\u003e\u003c/pre\u003e\u003cul\u003e\n\u003cli\u003eUNWIND takes something not a list and makes it a list. With \u003ccode\u003enodes(path)\u003c/code\u003e we\u0026#39;re getting all the nodes out (which will be Persons and Movies)\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ecoalesce\u003c/code\u003e is necessary because Persons have names and Movies have titles. This will take the first thing in there that\u0026#39;s not null.\u003c/li\u003e\n\u003cli\u003eWe use AS here to make these things easier to refer to later (both \u003ccode\u003enode\u003c/code\u003e and \u003ccode\u003etext\u003c/code\u003e)\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eFind Degrees in a Network\u003c/h2\u003e\n\u003cp\u003eYou could imagine if this was a recommendation engine, you may want to recommend people other actors and actresses based on movies people have appeared in together. What if we wanted to take that two degrees out?\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-cql\"\u003eMATCH (Halle:Person)-[:ACTED_IN*1..4]-(Recommendation:Person)\nWHERE Halle.name = \u0026quot;Halle Berry\u0026quot;\nRETURN DISTINCT Recommendation.name\nORDER BY Recommendation.name;\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThis will give you that extended network of people to check out. If you wanted to include diretory and writers in that count, just omit the \u003ccode\u003e:ACTED_IN\u003c/code\u003e so it\u0026#39;s \u003ccode\u003e-[*1..4]-\u003c/code\u003e and that will give you any relationship.\u003c/p\u003e\n","markdown":"\nThis section assumes you've inserted all the people and movies from the previous section. If not, [run this query][sample] to get all the data.\n\nLet's do some queries to familiarize ourselves with the data.\n\n```cql\nMATCH (n) RETURN distinct labels(n), count(*);\n```\n\nThis will query the database for all nodes (which is the `(n)` part, notice no label) and then it uses the builtin `labels()` function to get all the labels, and then counts those with `count(*)` function.\n\n```cql\nMATCH (n)-[r]-\u003e() RETURN type(r), count(*);\n```\n\nSimilar to above, we are now counting how many relationships we have in a database.\n\nOkay, so let's pick an actor or actress and find out what other people they've been in movies with. I'll pick Keanu Reeves here.\n\n```cql\nMATCH (Keanu:Person)-[:ACTED_IN]-\u003e(m:Movie)\u003c-[:ACTED_IN]-(Costar:Person)\nWHERE Keanu.name = \"Keanu Reeves\"\nRETURN DISTINCT Costar.name, count(*)\nORDER BY count(*) DESC, Costar.name;\n```\n\n- We've seen similar queries before as far as the MATCH goes.\n- Similar to above we're using a DISTINCT clause and then using `count(*)` to aggregate how many movies Keanu appeared in these movies with these people in.\n- ORDER BY should look familiar as it works very similar to PostgreSQL. I gave it two fields to order by so it'll order first by quantity of films they're in together then alphabetical by name.\n\nIf you're using the browser and you want to see a pretty graph, try this:\n\n```cql\nMATCH (Keanu:Person)-[:ACTED_IN]-\u003e(m:Movie)\u003c-[r:ACTED_IN]-(Costar:Person)\nWHERE Keanu.name = \"Keanu Reeves\"\nRETURN Costar, m, Keanu;\n```\n\nIf you want the nice graphics you need to return whole nodes and not just fields.\n\n## Degrees of Kevin Bacon\n\nSo the whole point of this dataset is to solve the [Six Degrees of Kevin Bacon][bacon] problem i.e. every actor and actress in Hollywood can be connected Kevin Bacon via them having acted in a film that acted in a film with him directly, with someone who was in a film with Kevin Bacon, or with someone who acted in a film with someone who was in a film with Kevin Bacon, and so-on-and-so-forth up to six degrees of separation.\n\nSo let's see how you could solve that problem with our dataset. Let's see how close Keanu is. (run this in the browser)\n\n```cql\nMATCH path = shortestPath(\n  (Bacon:Person {name:\"Kevin Bacon\"})-[*]-(Keanu:Person {name:\"Keanu Reeves\"})\n)\nRETURN path;\n```\n\n- `shortestPath` is a function that will find the shortest path between two nodes by looking at their relationships.\n- The variable `path` ends up being a path type. It contains all the information for a whole path within your grasp.\n- You can run this in cypher-shell but it'll give you a lot of data back.\n\nFor something more friendly to see in cypher-shell, just look at the length\n\n```cql\nMATCH path = shortestPath(\n  (Bacon:Person {name:\"Kevin Bacon\"})-[*]-(Keanu:Person {name:\"Keanu Reeves\"})\n)\nRETURN length(path);\n```\n\nTo unwind this in a way that would be readable in cypher-shell with all the movies and actors/actresses you could do this:\n\n```cql\nMATCH path = shortestPath(\n    (First:Person {name:\"Kevin Bacon\"})-[*]-(Second:Person {name:\"Keanu Reeves\"})\n)\nUNWIND nodes(path) AS node\nRETURN coalesce(node.name, node.title) AS text;\n```\n\n- UNWIND takes something not a list and makes it a list. With `nodes(path)` we're getting all the nodes out (which will be Persons and Movies)\n- `coalesce` is necessary because Persons have names and Movies have titles. This will take the first thing in there that's not null.\n- We use AS here to make these things easier to refer to later (both `node` and `text`)\n\n## Find Degrees in a Network\n\nYou could imagine if this was a recommendation engine, you may want to recommend people other actors and actresses based on movies people have appeared in together. What if we wanted to take that two degrees out?\n\n```cql\nMATCH (Halle:Person)-[:ACTED_IN*1..4]-(Recommendation:Person)\nWHERE Halle.name = \"Halle Berry\"\nRETURN DISTINCT Recommendation.name\nORDER BY Recommendation.name;\n```\n\nThis will give you that extended network of people to check out. If you wanted to include diretory and writers in that count, just omit the `:ACTED_IN` so it's `-[*1..4]-` and that will give you any relationship.\n\n[sample]: https://btholt.github.io/complete-intro-to-databases/sample-neo4j.cql\n[bacon]: https://en.wikipedia.org/wiki/Six_Degrees_of_Kevin_Bacon\n","slug":"complex-neo4j-queries","title":"Complex Neo4j Queries","section":"Graph","icon":"info-circle","filePath":"/home/runner/work/complete-intro-to-databases-v2/complete-intro-to-databases-v2/lessons/04-graph/D-complex-neo4j-queries.md","nextSlug":"/lessons/graph/indexes-in-neo4j","prevSlug":"/lessons/graph/neo4j-browser"}},"__N_SSG":true},"page":"/lessons/[section]/[slug]","query":{"section":"graph","slug":"complex-neo4j-queries"},"buildId":"Ogv8p-BwCHRQ1PzRpAU9u","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>