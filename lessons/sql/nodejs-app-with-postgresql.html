<!DOCTYPE html><html><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="width=device-width" data-next-head=""/><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png" data-next-head=""/><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png" data-next-head=""/><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png" data-next-head=""/><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png" data-next-head=""/><link rel="icon" type="image/x-icon" href="/images/favicon.ico" data-next-head=""/><title data-next-head="">Node.js App with PostgreSQL – Complete Intro to Databases v2</title><meta name="description" content="To help transfer learnings from the command line to code, Brian shows you how to quickly write an app for our message board tables using Node.js" data-next-head=""/><meta name="keywords" content="postgres,sql,redis,mongodb,neo4j,database,data,agents" data-next-head=""/><meta name="og:description" content="To help transfer learnings from the command line to code, Brian shows you how to quickly write an app for our message board tables using Node.js" data-next-head=""/><meta name="og:title" content="Node.js App with PostgreSQL – Complete Intro to Databases v2" data-next-head=""/><meta name="og:image" content="/images/social-share-cover.jpg" data-next-head=""/><meta name="twitter:card" content="summary_large_image" data-next-head=""/><link data-next-font="size-adjust" rel="preconnect" href="/" crossorigin="anonymous"/><link rel="preload" href="/_next/static/chunks/3802a39ca373f962.css" as="style"/><link rel="stylesheet" href="/_next/static/chunks/3802a39ca373f962.css" data-n-g=""/><noscript data-n-css=""></noscript><script src="/_next/static/chunks/dbe15a90055bd265.js" defer=""></script><script src="/_next/static/chunks/49c75c2ed6206f46.js" defer=""></script><script src="/_next/static/chunks/da0ff8adaa6cce90.js" defer=""></script><script src="/_next/static/chunks/turbopack-342361b32f83e6b6.js" defer=""></script><script src="/_next/static/chunks/f189af6b04c7fd39.js" defer=""></script><script src="/_next/static/chunks/turbopack-8b35dea75ba6f85c.js" defer=""></script><script src="/_next/static/Ogv8p-BwCHRQ1PzRpAU9u/_ssgManifest.js" defer=""></script><script src="/_next/static/Ogv8p-BwCHRQ1PzRpAU9u/_buildManifest.js" defer=""></script></head><body><script async="" defer="" src="https://a.holt.courses/latest.js"></script><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"/><div id="__next"><link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&amp;display=swap" rel="stylesheet"/><div class="remix-app"><header class="navbar"><h1 class="navbar-brand"><a href="/">Complete Intro to Databases v2</a></h1><div class="navbar-info"><a href="https://frontendmasters.com/workshops/databases-v2/" class="cta-btn">Watch on Frontend Masters</a></div></header><div class="content-container"><div class="main"><div class="lesson-container"><div class="lesson"><div class="lesson-content"><p>Let&#39;s quickly write up a quick Node.js project to help you transfer your skills from the command line to the coding world.</p>
<p><a href="https://github.com/btholt/db-samples">You can access all samples for this project here</a>.</p>
<p>Make a new directory. In that directory run:</p>
<pre><code class="hljs language-bash">npm init -y
npm i express pg@8.4.1 express@4.17.1
<span class="hljs-built_in">mkdir</span> static
<span class="hljs-built_in">touch</span> static/index.html server.js
code . <span class="hljs-comment"># or open this folder in VS Code or whatever editor you want</span>
</code></pre><p>Let&#39;s make a dumb front end that just makes search queries against the backend. In static/index.html put:</p>
<pre><code class="hljs language-html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;viewport&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>PostgreSQL Sample<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;Board ID Number&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;search&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;btn&quot;</span>&gt;</span>Search<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">pre</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">code</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;code&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">code</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">pre</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript">
      <span class="hljs-keyword">const</span> btn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;btn&quot;</span>);
      <span class="hljs-keyword">const</span> code = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;code&quot;</span>);
      <span class="hljs-keyword">const</span> search = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;search&quot;</span>);

      btn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;click&quot;</span>, <span class="hljs-title function_">async</span> () =&gt; {
        code.<span class="hljs-property">innerText</span> = <span class="hljs-string">&quot;loading&quot;</span>;

        <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(
          <span class="hljs-string">&quot;/get?search=&quot;</span> + <span class="hljs-built_in">encodeURIComponent</span>(search.<span class="hljs-property">value</span>)
        );
        <span class="hljs-keyword">const</span> json = <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>();

        code.<span class="hljs-property">innerText</span> = <span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(json, <span class="hljs-literal">null</span>, <span class="hljs-number">4</span>);
      });
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre><p>Normally I&#39;d say don&#39;t put a big script tag in there but we&#39;re going for simplicity right now. You can refactor this later to something better.</p>
<p>In server.js, put this:</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;express&quot;</span>);
<span class="hljs-keyword">const</span> { <span class="hljs-title class_">Pool</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;pg&quot;</span>);
<span class="hljs-keyword">const</span> pool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Pool</span>({
  <span class="hljs-attr">connectionString</span>:
    <span class="hljs-string">&quot;postgresql://postgres:mysecretpassword@localhost:5432/message_boards&quot;</span>,
});

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();

  app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/get&quot;</span>, <span class="hljs-title function_">async</span> (req, res) =&gt; {
    <span class="hljs-keyword">const</span> client = <span class="hljs-keyword">await</span> pool.<span class="hljs-title function_">connect</span>();
    <span class="hljs-keyword">const</span> [commentsRes, boardRes] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
      client.<span class="hljs-title function_">query</span>(
        <span class="hljs-string">`SELECT * FROM comments NATURAL LEFT JOIN rich_content WHERE board_id = <span class="hljs-subst">${req.query.search}</span>`</span>
        <span class="hljs-comment">// &quot;SELECT * FROM comments NATURAL LEFT JOIN rich_content WHERE board_id = $1&quot;,</span>
        <span class="hljs-comment">// [req.query.search]</span>
      ),
      client.<span class="hljs-title function_">query</span>(<span class="hljs-string">&quot;SELECT * FROM boards WHERE board_id = $1&quot;</span>, [
        req.<span class="hljs-property">query</span>.<span class="hljs-property">search</span>,
      ]),
    ]);
    res
      .<span class="hljs-title function_">json</span>({
        <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;ok&quot;</span>,
        <span class="hljs-attr">board</span>: boardRes.<span class="hljs-property">rows</span>[<span class="hljs-number">0</span>] || {},
        <span class="hljs-attr">posts</span>: commentsRes.<span class="hljs-property">rows</span>,
      })
      .<span class="hljs-title function_">end</span>();
    <span class="hljs-keyword">await</span> client.<span class="hljs-title function_">end</span>();
  });

  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PORT</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span> || <span class="hljs-number">3000</span>;
  app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">static</span>(<span class="hljs-string">&quot;./static&quot;</span>));
  app.<span class="hljs-title function_">listen</span>(<span class="hljs-variable constant_">PORT</span>);

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`running on http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
}
<span class="hljs-title function_">init</span>();
</code></pre><ul>
<li>This app is intentionally very similar to MongoDB one to show you accessing a database is pretty similar across the board.</li>
<li>We&#39;re using a connection pool. PostgreSQL can only handle so many connections and it&#39;s a slow process to constantly and disconnect. This instead will hold onto as many connections as it needs to and reuse them as it can.</li>
<li>We&#39;re using two queries. This is common. In this case we can optimize each query individually and probably even cache each result individually for performance.</li>
<li>I&#39;m lazily requesting <code>*</code> here. You should request only what you need.</li>
<li>With rich<em>content, it will create a new row in the response for _each</em> rich_content row it gets. You&#39;d have to combine these in the code which is okay. There are some fancier way to query to get it pre-combined or you could just do a third query.</li>
</ul>
<h2>SQL Injection</h2>
<ul>
<li>We&#39;re using what&#39;s a called a parameterized query with the <code>$1</code> business. Whenever you put user-given content directly into an SQL statement you need to be aware of the danger that a user can abuse that to run queries themselves against your database, potentially exposing sensitive data (like our user table) or doing destructive things (like dropping all of our tables).</li>
</ul>
<p>Let&#39;s say we were a little less cautious and our code looked like this:</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;express&quot;</span>);
<span class="hljs-keyword">const</span> { <span class="hljs-title class_">Pool</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;pg&quot;</span>);
<span class="hljs-keyword">const</span> pool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Pool</span>({
  <span class="hljs-attr">connectionString</span>:
    <span class="hljs-string">&quot;postgresql://postgres:mysecretpassword@localhost:5432/message_boards&quot;</span>,
});

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();

  app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/get&quot;</span>, <span class="hljs-title function_">async</span> (req, res) =&gt; {
    <span class="hljs-keyword">const</span> client = <span class="hljs-keyword">await</span> pool.<span class="hljs-title function_">connect</span>();
    <span class="hljs-keyword">const</span> [commentsRes, boardRes] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
      client.<span class="hljs-title function_">query</span>(
        <span class="hljs-string">`SELECT * FROM comments NATURAL LEFT JOIN rich_content WHERE board_id = <span class="hljs-subst">${req.query.search}</span>`</span>
        <span class="hljs-comment">// &quot;SELECT * FROM comments NATURAL LEFT JOIN rich_content WHERE board_id = $1&quot;,</span>
        <span class="hljs-comment">// [req.query.search]</span>
      ),
      client.<span class="hljs-title function_">query</span>(<span class="hljs-string">&quot;SELECT * FROM boards WHERE board_id = $1&quot;</span>, [
        <span class="hljs-comment">// req.query.search,</span>
        <span class="hljs-number">39</span>,
      ]),
    ]);
    res
      .<span class="hljs-title function_">json</span>({
        <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;ok&quot;</span>,
        <span class="hljs-attr">board</span>: boardRes.<span class="hljs-property">rows</span>[<span class="hljs-number">0</span>] || {},
        <span class="hljs-comment">// posts: commentsRes.rows,</span>
        <span class="hljs-attr">posts</span>: commentsRes,
      })
      .<span class="hljs-title function_">end</span>();
    <span class="hljs-keyword">await</span> client.<span class="hljs-title function_">end</span>();
  });

  app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">static</span>(<span class="hljs-string">&quot;./static&quot;</span>));
  app.<span class="hljs-title function_">listen</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span> || <span class="hljs-number">3000</span>);
}
<span class="hljs-title function_">init</span>();
</code></pre><ul>
<li>What if we put <code>1; SELECT * FROM users; --</code> as our search term. The <code>1;</code> would satisfy the first query, and then we could run a second query to show all of the users in our database. Very, very bad.</li>
<li>Now, I had to change some code to actually get it to display the exfiltrated data but that&#39;s not even necessary. What if we put <code>1; DROP TABLE users; --</code>? It&#39;d wipe out our entire users database! Hope we have a backup.</li>
<li>There&#39;s actually a lot more they can do. They could add a new user to PostgreSQL, grab its IP address, and then connect to the database itself.</li>
<li>Needless to say, this is a disaster if it happens to you. Parameterized queries prevent this (the way we coded it above). It won&#39;t let the thing going into the query be anything that SQL can interept as an action.</li>
</ul>
</div><div class="lesson-links"><a class="prev" href="/lessons/sql/indexes-in-postgresql">← Previous</a><a class="next" href="/lessons/sql/hasura">Next →</a></div></div><div class="details-bg"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="154" height="154" viewBox="0 0 154 154"><defs><clipPath id="clip-path"><rect id="Rectangle_2238" data-name="Rectangle 2238" width="154" height="154" transform="translate(9467 350)" fill="#fff" stroke="#707070" stroke-width="1"></rect></clipPath><clipPath id="clip-corner-image-active"><rect width="154" height="154"></rect></clipPath></defs><g id="corner-image-active" clip-path="url(#clip-corner-image-active)"><g id="Corner-image-active-2" data-name="Corner-image-active" transform="translate(-9467 -350)" clip-path="url(#clip-path)"><path id="Subtraction_34" data-name="Subtraction 34" d="M-3857.365,1740.766h0l-7.07-7.07,12.89-12.89v14.142l-5.818,5.818Zm-14.142-14.142h0l-7.071-7.07,27.033-27.033v14.143l-19.96,19.96Zm-14.143-14.143h0l-7.07-7.069,41.175-41.175v14.142Zm-14.142-14.142h0l-7.07-7.069,55.317-55.317v14.142Zm-14.142-14.142h0l-7.07-7.069,69.459-69.459v14.142Zm-14.142-14.142h0l-7.07-7.069,76.739-76.739h6.862v7.28Zm-14.143-14.143h0l-7.07-7.069,62.6-62.6h14.142Zm-14.142-14.142h0l-7.07-7.069,48.454-48.454h14.142Zm-14.142-14.142h0l-7.07-7.069,34.312-34.312h14.142Zm-14.142-14.142h0l-7.07-7.069,20.17-20.17h14.142Zm-14.142-14.142h0l-7.071-7.071,6.027-6.027h14.144l-13.1,13.1Zm367.24-56.114v-.909l.455.455-.453.453Z" transform="translate(13472.546 -1236.766)" fill="var(--corner-fill)"></path></g></g></svg></div></div></div></div><footer class="footer"><ul class="socials"><li class="social"><a href="https://twitter.com/holtbt"><svg fill="none" height="100%" width="32" xmlns="http://www.w3.org/2000/svg" viewBox="0.254 0.25 500 451.95400000000006"><path d="M394.033.25h76.67L303.202 191.693l197.052 260.511h-154.29L225.118 294.205 86.844 452.204H10.127l179.16-204.77L.254.25H158.46l109.234 144.417zm-26.908 406.063h42.483L135.377 43.73h-45.59z" fill="var(--footer-icons)"></path></svg></a></li><li class="social"><a href="https://bsky.app/profile/brianholt.me"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -3.268 64 68.414" width="38" height="100%"><path fill="var(--footer-icons)" d="M13.873 3.805C21.21 9.332 29.103 20.537 32 26.55v15.882c0-.338-.13.044-.41.867-1.512 4.456-7.418 21.847-20.923 7.944-7.111-7.32-3.819-14.64 9.125-16.85-7.405 1.264-15.73-.825-18.014-9.015C1.12 23.022 0 8.51 0 6.55 0-3.268 8.579-.182 13.873 3.805zm36.254 0C42.79 9.332 34.897 20.537 32 26.55v15.882c0-.338.13.044.41.867 1.512 4.456 7.418 21.847 20.923 7.944 7.111-7.32 3.819-14.64-9.125-16.85 7.405 1.264 15.73-.825 18.014-9.015C62.88 23.022 64 8.51 64 6.55c0-9.818-8.578-6.732-13.873-2.745z"></path></svg></a></li><li class="social"><a href="https://github.com/btholt"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 32 32"><defs><clipPath id="clip-github-social"><rect width="32" height="32"></rect></clipPath></defs><g id="github-social" clip-path="url(#clip-github-social)"><g id="Group_272" data-name="Group 272" transform="translate(13522.5 -6994)"><path id="Subtraction_33" data-name="Subtraction 33" d="M-24967.5,8041a15.9,15.9,0,0,1-11.312-4.688A15.893,15.893,0,0,1-24983.5,8025a15.893,15.893,0,0,1,4.689-11.315A15.894,15.894,0,0,1-24967.5,8009a15.894,15.894,0,0,1,11.313,4.686A15.893,15.893,0,0,1-24951.5,8025a15.893,15.893,0,0,1-4.689,11.313A15.9,15.9,0,0,1-24967.5,8041Zm-3.781-4.571h0v3.918h7.895v-6.665a1.836,1.836,0,0,0-1.2-1.718c5.1-.617,7.467-2.975,7.467-7.424a7.176,7.176,0,0,0-1.637-4.728,6.74,6.74,0,0,0,.275-1.812,4.34,4.34,0,0,0-.52-2.452.574.574,0,0,0-.359-.1c-1.061,0-3.465,1.411-3.936,1.694a16.644,16.644,0,0,0-4.2-.489,16.379,16.379,0,0,0-3.969.445c-.846-.5-2.91-1.649-3.859-1.649a.566.566,0,0,0-.354.095,4.3,4.3,0,0,0-.521,2.452,6.7,6.7,0,0,0,.244,1.718,7.346,7.346,0,0,0-1.6,4.822,7.263,7.263,0,0,0,1.533,4.985c1.193,1.359,3.115,2.165,5.871,2.464a1.826,1.826,0,0,0-1.129,1.693v.5h0l-.006,0a7.121,7.121,0,0,1-2.033.363,2.608,2.608,0,0,1-.965-.158,4.438,4.438,0,0,1-1.836-1.881,2.361,2.361,0,0,0-1.248-1.091,3.472,3.472,0,0,0-1.217-.3.584.584,0,0,0-.545.224.282.282,0,0,0,.027.367,1.875,1.875,0,0,0,.447.307,4.732,4.732,0,0,1,.561.355,10.726,10.726,0,0,1,1.682,2.755c.043.092.078.163.105.217a3.876,3.876,0,0,0,2.42,1.185,6.036,6.036,0,0,0,.607.025c.875,0,1.988-.124,2-.125Z" transform="translate(11461 -1015)" fill="var(--footer-icons)"></path><g id="Ellipse_670" data-name="Ellipse 670" transform="translate(-13522.5 6994)" fill="none" stroke="var(--footer-icons)" stroke-width="1"><circle cx="16" cy="16" r="16" stroke="none"></circle><circle cx="16" cy="16" r="15.5" fill="none"></circle></g></g></g></svg></a></li><li class="social"><a href="https://linkedin.com/in/btholt"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 32 32"><defs><clipPath id="clip-linkedin-social"><rect width="32" height="32"></rect></clipPath></defs><g id="linkedin-social" clip-path="url(#clip-linkedin-social)"><g id="Group_270" data-name="Group 270" transform="translate(-86.349 -633.073)"><path id="Path_375" data-name="Path 375" d="M115.789,633.073a2.324,2.324,0,0,1,1.682.676,2.194,2.194,0,0,1,.695,1.627V662.8a2.131,2.131,0,0,1-.695,1.609,2.314,2.314,0,0,1-1.646.659H88.69a2.307,2.307,0,0,1-1.646-.659,2.128,2.128,0,0,1-.695-1.609V635.376a2.19,2.19,0,0,1,.695-1.627,2.322,2.322,0,0,1,1.682-.676h27.063Zm-20.224,9.672a2.561,2.561,0,0,0,0-3.584,2.658,2.658,0,0,0-1.938-.712,2.724,2.724,0,0,0-1.957.712,2.371,2.371,0,0,0-.75,1.792,2.4,2.4,0,0,0,.731,1.792,2.605,2.605,0,0,0,1.9.713h.037A2.7,2.7,0,0,0,95.565,642.745ZM96,645.434H91.213V659.88H96Zm17.3,6.144a7.007,7.007,0,0,0-1.573-4.9,5.68,5.68,0,0,0-6.839-.769,5.663,5.663,0,0,0-1.426,1.573v-2.048H98.674q.036.841,0,7.717v6.728h4.791V651.8a3.592,3.592,0,0,1,.146-1.17,2.913,2.913,0,0,1,.878-1.206,2.429,2.429,0,0,1,1.609-.549,2.108,2.108,0,0,1,1.865.914,4.265,4.265,0,0,1,.549,2.341v7.752H113.3Z" fill="var(--footer-icons)"></path></g></g></svg></a></li><li class="social"><div class="terms"><p>Content Licensed Under CC-BY-NC-4.0</p><p>Code Samples and Exercises Licensed Under Apache 2.0</p><p>Site Designed by<!-- --> <a href="https://www.alexdanielson.com/">Alex Danielson</a></p></div></li></ul><div class="theme-icons"><button aria-label="Activate dark mode" title="Activate dark mode" class="theme-toggle"><svg xmlns="http://www.w3.org/2000/svg" width="36px" height="100%" viewBox="0 -960 960 960" fill="var(--text-footer)" role="img"><title>Dark Mode Icon</title><path d="M480-120q-150 0-255-105T120-480q0-150 105-255t255-105q14 0 27.5 1t26.5 3q-41 29-65.5 75.5T444-660q0 90 63 153t153 63q55 0 101-24.5t75-65.5q2 13 3 26.5t1 27.5q0 150-105 255T480-120Zm0-80q88 0 158-48.5T740-375q-20 5-40 8t-40 3q-123 0-209.5-86.5T364-660q0-20 3-40t8-40q-78 32-126.5 102T200-480q0 116 82 198t198 82Z"></path></svg></button></div></footer></div><noscript><img src="https://a.holt.courses/noscript.gif" alt="" referrerPolicy="no-referrer-when-downgrade"/></noscript></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"attributes":{"title":"Node.js App with PostgreSQL","description":"To help transfer learnings from the command line to code, Brian shows you how to quickly write an app for our message board tables using Node.js"},"html":"\u003cp\u003eLet\u0026#39;s quickly write up a quick Node.js project to help you transfer your skills from the command line to the coding world.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/btholt/db-samples\"\u003eYou can access all samples for this project here\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eMake a new directory. In that directory run:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003enpm init -y\nnpm i express pg@8.4.1 express@4.17.1\n\u003cspan class=\"hljs-built_in\"\u003emkdir\u003c/span\u003e static\n\u003cspan class=\"hljs-built_in\"\u003etouch\u003c/span\u003e static/index.html server.js\ncode . \u003cspan class=\"hljs-comment\"\u003e# or open this folder in VS Code or whatever editor you want\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eLet\u0026#39;s make a dumb front end that just makes search queries against the backend. In static/index.html put:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-html\"\u003e\u003cspan class=\"hljs-meta\"\u003e\u0026lt;!DOCTYPE \u003cspan class=\"hljs-keyword\"\u003ehtml\u003c/span\u003e\u0026gt;\u003c/span\u003e\n\u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003ehtml\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003elang\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;en\u0026quot;\u003c/span\u003e\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003ehead\u003c/span\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003emeta\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003echarset\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;UTF-8\u0026quot;\u003c/span\u003e /\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003emeta\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;viewport\u0026quot;\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003econtent\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;width=device-width, initial-scale=1.0\u0026quot;\u003c/span\u003e /\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003etitle\u003c/span\u003e\u0026gt;\u003c/span\u003ePostgreSQL Sample\u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003etitle\u003c/span\u003e\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003ehead\u003c/span\u003e\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003ebody\u003c/span\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003einput\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003etype\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;text\u0026quot;\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eplaceholder\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;Board ID Number\u0026quot;\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eid\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;search\u0026quot;\u003c/span\u003e /\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003ebutton\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eid\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;btn\u0026quot;\u003c/span\u003e\u0026gt;\u003c/span\u003eSearch\u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003ebutton\u003c/span\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003epre\u003c/span\u003e\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003ecode\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eid\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;code\u0026quot;\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003ecode\u003c/span\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003epre\u003c/span\u003e\u0026gt;\u003c/span\u003e\n\n    \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003escript\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"language-javascript\"\u003e\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e btn = \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003egetElementById\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;btn\u0026quot;\u003c/span\u003e);\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e code = \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003egetElementById\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;code\u0026quot;\u003c/span\u003e);\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e search = \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003egetElementById\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;search\u0026quot;\u003c/span\u003e);\n\n      btn.\u003cspan class=\"hljs-title function_\"\u003eaddEventListener\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;click\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-title function_\"\u003easync\u003c/span\u003e () =\u0026gt; {\n        code.\u003cspan class=\"hljs-property\"\u003einnerText\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e\u0026quot;loading\u0026quot;\u003c/span\u003e;\n\n        \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e res = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003efetch\u003c/span\u003e(\n          \u003cspan class=\"hljs-string\"\u003e\u0026quot;/get?search=\u0026quot;\u003c/span\u003e + \u003cspan class=\"hljs-built_in\"\u003eencodeURIComponent\u003c/span\u003e(search.\u003cspan class=\"hljs-property\"\u003evalue\u003c/span\u003e)\n        );\n        \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e json = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e res.\u003cspan class=\"hljs-title function_\"\u003ejson\u003c/span\u003e();\n\n        code.\u003cspan class=\"hljs-property\"\u003einnerText\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e\u0026quot;\\n\u0026quot;\u003c/span\u003e + \u003cspan class=\"hljs-title class_\"\u003eJSON\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003estringify\u003c/span\u003e(json, \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e);\n      });\n    \u003c/span\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003escript\u003c/span\u003e\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003ebody\u003c/span\u003e\u0026gt;\u003c/span\u003e\n\u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003ehtml\u003c/span\u003e\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eNormally I\u0026#39;d say don\u0026#39;t put a big script tag in there but we\u0026#39;re going for simplicity right now. You can refactor this later to something better.\u003c/p\u003e\n\u003cp\u003eIn server.js, put this:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e express = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;express\u0026quot;\u003c/span\u003e);\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e { \u003cspan class=\"hljs-title class_\"\u003ePool\u003c/span\u003e } = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;pg\u0026quot;\u003c/span\u003e);\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e pool = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePool\u003c/span\u003e({\n  \u003cspan class=\"hljs-attr\"\u003econnectionString\u003c/span\u003e:\n    \u003cspan class=\"hljs-string\"\u003e\u0026quot;postgresql://postgres:mysecretpassword@localhost:5432/message_boards\u0026quot;\u003c/span\u003e,\n});\n\n\u003cspan class=\"hljs-keyword\"\u003easync\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003einit\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e app = \u003cspan class=\"hljs-title function_\"\u003eexpress\u003c/span\u003e();\n\n  app.\u003cspan class=\"hljs-title function_\"\u003eget\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;/get\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-title function_\"\u003easync\u003c/span\u003e (req, res) =\u0026gt; {\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e client = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e pool.\u003cspan class=\"hljs-title function_\"\u003econnect\u003c/span\u003e();\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e [commentsRes, boardRes] = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePromise\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eall\u003c/span\u003e([\n      client.\u003cspan class=\"hljs-title function_\"\u003equery\u003c/span\u003e(\n        \u003cspan class=\"hljs-string\"\u003e`SELECT * FROM comments NATURAL LEFT JOIN rich_content WHERE board_id = \u003cspan class=\"hljs-subst\"\u003e${req.query.search}\u003c/span\u003e`\u003c/span\u003e\n        \u003cspan class=\"hljs-comment\"\u003e// \u0026quot;SELECT * FROM comments NATURAL LEFT JOIN rich_content WHERE board_id = $1\u0026quot;,\u003c/span\u003e\n        \u003cspan class=\"hljs-comment\"\u003e// [req.query.search]\u003c/span\u003e\n      ),\n      client.\u003cspan class=\"hljs-title function_\"\u003equery\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;SELECT * FROM boards WHERE board_id = $1\u0026quot;\u003c/span\u003e, [\n        req.\u003cspan class=\"hljs-property\"\u003equery\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003esearch\u003c/span\u003e,\n      ]),\n    ]);\n    res\n      .\u003cspan class=\"hljs-title function_\"\u003ejson\u003c/span\u003e({\n        \u003cspan class=\"hljs-attr\"\u003estatus\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;ok\u0026quot;\u003c/span\u003e,\n        \u003cspan class=\"hljs-attr\"\u003eboard\u003c/span\u003e: boardRes.\u003cspan class=\"hljs-property\"\u003erows\u003c/span\u003e[\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e] || {},\n        \u003cspan class=\"hljs-attr\"\u003eposts\u003c/span\u003e: commentsRes.\u003cspan class=\"hljs-property\"\u003erows\u003c/span\u003e,\n      })\n      .\u003cspan class=\"hljs-title function_\"\u003eend\u003c/span\u003e();\n    \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e client.\u003cspan class=\"hljs-title function_\"\u003eend\u003c/span\u003e();\n  });\n\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003ePORT\u003c/span\u003e = process.\u003cspan class=\"hljs-property\"\u003eenv\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ePORT\u003c/span\u003e || \u003cspan class=\"hljs-number\"\u003e3000\u003c/span\u003e;\n  app.\u003cspan class=\"hljs-title function_\"\u003euse\u003c/span\u003e(express.\u003cspan class=\"hljs-title function_\"\u003estatic\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;./static\u0026quot;\u003c/span\u003e));\n  app.\u003cspan class=\"hljs-title function_\"\u003elisten\u003c/span\u003e(\u003cspan class=\"hljs-variable constant_\"\u003ePORT\u003c/span\u003e);\n\n  \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e`running on http://localhost:\u003cspan class=\"hljs-subst\"\u003e${PORT}\u003c/span\u003e`\u003c/span\u003e);\n}\n\u003cspan class=\"hljs-title function_\"\u003einit\u003c/span\u003e();\n\u003c/code\u003e\u003c/pre\u003e\u003cul\u003e\n\u003cli\u003eThis app is intentionally very similar to MongoDB one to show you accessing a database is pretty similar across the board.\u003c/li\u003e\n\u003cli\u003eWe\u0026#39;re using a connection pool. PostgreSQL can only handle so many connections and it\u0026#39;s a slow process to constantly and disconnect. This instead will hold onto as many connections as it needs to and reuse them as it can.\u003c/li\u003e\n\u003cli\u003eWe\u0026#39;re using two queries. This is common. In this case we can optimize each query individually and probably even cache each result individually for performance.\u003c/li\u003e\n\u003cli\u003eI\u0026#39;m lazily requesting \u003ccode\u003e*\u003c/code\u003e here. You should request only what you need.\u003c/li\u003e\n\u003cli\u003eWith rich\u003cem\u003econtent, it will create a new row in the response for _each\u003c/em\u003e rich_content row it gets. You\u0026#39;d have to combine these in the code which is okay. There are some fancier way to query to get it pre-combined or you could just do a third query.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eSQL Injection\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eWe\u0026#39;re using what\u0026#39;s a called a parameterized query with the \u003ccode\u003e$1\u003c/code\u003e business. Whenever you put user-given content directly into an SQL statement you need to be aware of the danger that a user can abuse that to run queries themselves against your database, potentially exposing sensitive data (like our user table) or doing destructive things (like dropping all of our tables).\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eLet\u0026#39;s say we were a little less cautious and our code looked like this:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e express = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;express\u0026quot;\u003c/span\u003e);\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e { \u003cspan class=\"hljs-title class_\"\u003ePool\u003c/span\u003e } = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;pg\u0026quot;\u003c/span\u003e);\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e pool = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePool\u003c/span\u003e({\n  \u003cspan class=\"hljs-attr\"\u003econnectionString\u003c/span\u003e:\n    \u003cspan class=\"hljs-string\"\u003e\u0026quot;postgresql://postgres:mysecretpassword@localhost:5432/message_boards\u0026quot;\u003c/span\u003e,\n});\n\n\u003cspan class=\"hljs-keyword\"\u003easync\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003einit\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e app = \u003cspan class=\"hljs-title function_\"\u003eexpress\u003c/span\u003e();\n\n  app.\u003cspan class=\"hljs-title function_\"\u003eget\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;/get\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-title function_\"\u003easync\u003c/span\u003e (req, res) =\u0026gt; {\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e client = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e pool.\u003cspan class=\"hljs-title function_\"\u003econnect\u003c/span\u003e();\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e [commentsRes, boardRes] = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePromise\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eall\u003c/span\u003e([\n      client.\u003cspan class=\"hljs-title function_\"\u003equery\u003c/span\u003e(\n        \u003cspan class=\"hljs-string\"\u003e`SELECT * FROM comments NATURAL LEFT JOIN rich_content WHERE board_id = \u003cspan class=\"hljs-subst\"\u003e${req.query.search}\u003c/span\u003e`\u003c/span\u003e\n        \u003cspan class=\"hljs-comment\"\u003e// \u0026quot;SELECT * FROM comments NATURAL LEFT JOIN rich_content WHERE board_id = $1\u0026quot;,\u003c/span\u003e\n        \u003cspan class=\"hljs-comment\"\u003e// [req.query.search]\u003c/span\u003e\n      ),\n      client.\u003cspan class=\"hljs-title function_\"\u003equery\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;SELECT * FROM boards WHERE board_id = $1\u0026quot;\u003c/span\u003e, [\n        \u003cspan class=\"hljs-comment\"\u003e// req.query.search,\u003c/span\u003e\n        \u003cspan class=\"hljs-number\"\u003e39\u003c/span\u003e,\n      ]),\n    ]);\n    res\n      .\u003cspan class=\"hljs-title function_\"\u003ejson\u003c/span\u003e({\n        \u003cspan class=\"hljs-attr\"\u003estatus\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;ok\u0026quot;\u003c/span\u003e,\n        \u003cspan class=\"hljs-attr\"\u003eboard\u003c/span\u003e: boardRes.\u003cspan class=\"hljs-property\"\u003erows\u003c/span\u003e[\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e] || {},\n        \u003cspan class=\"hljs-comment\"\u003e// posts: commentsRes.rows,\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003eposts\u003c/span\u003e: commentsRes,\n      })\n      .\u003cspan class=\"hljs-title function_\"\u003eend\u003c/span\u003e();\n    \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e client.\u003cspan class=\"hljs-title function_\"\u003eend\u003c/span\u003e();\n  });\n\n  app.\u003cspan class=\"hljs-title function_\"\u003euse\u003c/span\u003e(express.\u003cspan class=\"hljs-title function_\"\u003estatic\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;./static\u0026quot;\u003c/span\u003e));\n  app.\u003cspan class=\"hljs-title function_\"\u003elisten\u003c/span\u003e(process.\u003cspan class=\"hljs-property\"\u003eenv\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ePORT\u003c/span\u003e || \u003cspan class=\"hljs-number\"\u003e3000\u003c/span\u003e);\n}\n\u003cspan class=\"hljs-title function_\"\u003einit\u003c/span\u003e();\n\u003c/code\u003e\u003c/pre\u003e\u003cul\u003e\n\u003cli\u003eWhat if we put \u003ccode\u003e1; SELECT * FROM users; --\u003c/code\u003e as our search term. The \u003ccode\u003e1;\u003c/code\u003e would satisfy the first query, and then we could run a second query to show all of the users in our database. Very, very bad.\u003c/li\u003e\n\u003cli\u003eNow, I had to change some code to actually get it to display the exfiltrated data but that\u0026#39;s not even necessary. What if we put \u003ccode\u003e1; DROP TABLE users; --\u003c/code\u003e? It\u0026#39;d wipe out our entire users database! Hope we have a backup.\u003c/li\u003e\n\u003cli\u003eThere\u0026#39;s actually a lot more they can do. They could add a new user to PostgreSQL, grab its IP address, and then connect to the database itself.\u003c/li\u003e\n\u003cli\u003eNeedless to say, this is a disaster if it happens to you. Parameterized queries prevent this (the way we coded it above). It won\u0026#39;t let the thing going into the query be anything that SQL can interept as an action.\u003c/li\u003e\n\u003c/ul\u003e\n","markdown":"\nLet's quickly write up a quick Node.js project to help you transfer your skills from the command line to the coding world.\n\n[You can access all samples for this project here][samples].\n\nMake a new directory. In that directory run:\n\n```bash\nnpm init -y\nnpm i express pg@8.4.1 express@4.17.1\nmkdir static\ntouch static/index.html server.js\ncode . # or open this folder in VS Code or whatever editor you want\n```\n\nLet's make a dumb front end that just makes search queries against the backend. In static/index.html put:\n\n```html\n\u003c!DOCTYPE html\u003e\n\u003chtml lang=\"en\"\u003e\n  \u003chead\u003e\n    \u003cmeta charset=\"UTF-8\" /\u003e\n    \u003cmeta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" /\u003e\n    \u003ctitle\u003ePostgreSQL Sample\u003c/title\u003e\n  \u003c/head\u003e\n  \u003cbody\u003e\n    \u003cinput type=\"text\" placeholder=\"Board ID Number\" id=\"search\" /\u003e\n    \u003cbutton id=\"btn\"\u003eSearch\u003c/button\u003e\n    \u003cpre\u003e\n        \u003ccode id=\"code\"\u003e\u003c/code\u003e\n    \u003c/pre\u003e\n\n    \u003cscript\u003e\n      const btn = document.getElementById(\"btn\");\n      const code = document.getElementById(\"code\");\n      const search = document.getElementById(\"search\");\n\n      btn.addEventListener(\"click\", async () =\u003e {\n        code.innerText = \"loading\";\n\n        const res = await fetch(\n          \"/get?search=\" + encodeURIComponent(search.value)\n        );\n        const json = await res.json();\n\n        code.innerText = \"\\n\" + JSON.stringify(json, null, 4);\n      });\n    \u003c/script\u003e\n  \u003c/body\u003e\n\u003c/html\u003e\n```\n\nNormally I'd say don't put a big script tag in there but we're going for simplicity right now. You can refactor this later to something better.\n\nIn server.js, put this:\n\n```javascript\nconst express = require(\"express\");\nconst { Pool } = require(\"pg\");\nconst pool = new Pool({\n  connectionString:\n    \"postgresql://postgres:mysecretpassword@localhost:5432/message_boards\",\n});\n\nasync function init() {\n  const app = express();\n\n  app.get(\"/get\", async (req, res) =\u003e {\n    const client = await pool.connect();\n    const [commentsRes, boardRes] = await Promise.all([\n      client.query(\n        `SELECT * FROM comments NATURAL LEFT JOIN rich_content WHERE board_id = ${req.query.search}`\n        // \"SELECT * FROM comments NATURAL LEFT JOIN rich_content WHERE board_id = $1\",\n        // [req.query.search]\n      ),\n      client.query(\"SELECT * FROM boards WHERE board_id = $1\", [\n        req.query.search,\n      ]),\n    ]);\n    res\n      .json({\n        status: \"ok\",\n        board: boardRes.rows[0] || {},\n        posts: commentsRes.rows,\n      })\n      .end();\n    await client.end();\n  });\n\n  const PORT = process.env.PORT || 3000;\n  app.use(express.static(\"./static\"));\n  app.listen(PORT);\n\n  console.log(`running on http://localhost:${PORT}`);\n}\ninit();\n```\n\n- This app is intentionally very similar to MongoDB one to show you accessing a database is pretty similar across the board.\n- We're using a connection pool. PostgreSQL can only handle so many connections and it's a slow process to constantly and disconnect. This instead will hold onto as many connections as it needs to and reuse them as it can.\n- We're using two queries. This is common. In this case we can optimize each query individually and probably even cache each result individually for performance.\n- I'm lazily requesting `*` here. You should request only what you need.\n- With rich*content, it will create a new row in the response for \\_each* rich_content row it gets. You'd have to combine these in the code which is okay. There are some fancier way to query to get it pre-combined or you could just do a third query.\n\n## SQL Injection\n\n- We're using what's a called a parameterized query with the `$1` business. Whenever you put user-given content directly into an SQL statement you need to be aware of the danger that a user can abuse that to run queries themselves against your database, potentially exposing sensitive data (like our user table) or doing destructive things (like dropping all of our tables).\n\nLet's say we were a little less cautious and our code looked like this:\n\n```javascript\nconst express = require(\"express\");\nconst { Pool } = require(\"pg\");\nconst pool = new Pool({\n  connectionString:\n    \"postgresql://postgres:mysecretpassword@localhost:5432/message_boards\",\n});\n\nasync function init() {\n  const app = express();\n\n  app.get(\"/get\", async (req, res) =\u003e {\n    const client = await pool.connect();\n    const [commentsRes, boardRes] = await Promise.all([\n      client.query(\n        `SELECT * FROM comments NATURAL LEFT JOIN rich_content WHERE board_id = ${req.query.search}`\n        // \"SELECT * FROM comments NATURAL LEFT JOIN rich_content WHERE board_id = $1\",\n        // [req.query.search]\n      ),\n      client.query(\"SELECT * FROM boards WHERE board_id = $1\", [\n        // req.query.search,\n        39,\n      ]),\n    ]);\n    res\n      .json({\n        status: \"ok\",\n        board: boardRes.rows[0] || {},\n        // posts: commentsRes.rows,\n        posts: commentsRes,\n      })\n      .end();\n    await client.end();\n  });\n\n  app.use(express.static(\"./static\"));\n  app.listen(process.env.PORT || 3000);\n}\ninit();\n```\n\n- What if we put `1; SELECT * FROM users; --` as our search term. The `1;` would satisfy the first query, and then we could run a second query to show all of the users in our database. Very, very bad.\n- Now, I had to change some code to actually get it to display the exfiltrated data but that's not even necessary. What if we put `1; DROP TABLE users; --`? It'd wipe out our entire users database! Hope we have a backup.\n- There's actually a lot more they can do. They could add a new user to PostgreSQL, grab its IP address, and then connect to the database itself.\n- Needless to say, this is a disaster if it happens to you. Parameterized queries prevent this (the way we coded it above). It won't let the thing going into the query be anything that SQL can interept as an action.\n\n[samples]: https://github.com/btholt/db-samples\n","slug":"nodejs-app-with-postgresql","title":"Node.js App with PostgreSQL","section":"Sql","icon":"info-circle","filePath":"/home/runner/work/complete-intro-to-databases-v2/complete-intro-to-databases-v2/lessons/03-sql/G-nodejs-app-with-postgresql.md","nextSlug":"/lessons/sql/hasura","prevSlug":"/lessons/sql/indexes-in-postgresql"}},"__N_SSG":true},"page":"/lessons/[section]/[slug]","query":{"section":"sql","slug":"nodejs-app-with-postgresql"},"buildId":"Ogv8p-BwCHRQ1PzRpAU9u","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>