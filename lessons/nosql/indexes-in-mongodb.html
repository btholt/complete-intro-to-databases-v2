<!DOCTYPE html><html><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="width=device-width" data-next-head=""/><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png" data-next-head=""/><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png" data-next-head=""/><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png" data-next-head=""/><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png" data-next-head=""/><link rel="icon" type="image/x-icon" href="/images/favicon.ico" data-next-head=""/><title data-next-head="">Indexes in Mongodb – Complete Intro to Databases v2</title><meta name="description" content="When querying against MongoDB, query performance can be very important. Brian shows you how to think about indexing a MongoDB database to improve performance and capabilities." data-next-head=""/><meta name="keywords" content="postgres,sql,redis,mongodb,neo4j,database,data,agents" data-next-head=""/><meta name="og:description" content="When querying against MongoDB, query performance can be very important. Brian shows you how to think about indexing a MongoDB database to improve performance and capabilities." data-next-head=""/><meta name="og:title" content="Indexes in Mongodb – Complete Intro to Databases v2" data-next-head=""/><meta name="og:image" content="/images/social-share-cover.jpg" data-next-head=""/><meta name="twitter:card" content="summary_large_image" data-next-head=""/><link data-next-font="size-adjust" rel="preconnect" href="/" crossorigin="anonymous"/><link rel="preload" href="/_next/static/chunks/3802a39ca373f962.css" as="style"/><link rel="stylesheet" href="/_next/static/chunks/3802a39ca373f962.css" data-n-g=""/><noscript data-n-css=""></noscript><script src="/_next/static/chunks/dbe15a90055bd265.js" defer=""></script><script src="/_next/static/chunks/49c75c2ed6206f46.js" defer=""></script><script src="/_next/static/chunks/da0ff8adaa6cce90.js" defer=""></script><script src="/_next/static/chunks/turbopack-342361b32f83e6b6.js" defer=""></script><script src="/_next/static/chunks/f189af6b04c7fd39.js" defer=""></script><script src="/_next/static/chunks/turbopack-8b35dea75ba6f85c.js" defer=""></script><script src="/_next/static/Ogv8p-BwCHRQ1PzRpAU9u/_ssgManifest.js" defer=""></script><script src="/_next/static/Ogv8p-BwCHRQ1PzRpAU9u/_buildManifest.js" defer=""></script></head><body><script async="" defer="" src="https://a.holt.courses/latest.js"></script><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"/><div id="__next"><link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&amp;display=swap" rel="stylesheet"/><div class="remix-app"><header class="navbar"><h1 class="navbar-brand"><a href="/">Complete Intro to Databases v2</a></h1><div class="navbar-info"><a href="https://frontendmasters.com/workshops/databases-v2/" class="cta-btn">Watch on Frontend Masters</a></div></header><div class="content-container"><div class="main"><div class="lesson-container"><div class="lesson"><div class="lesson-content"><p>Databases are honestly marvels of technology. I remember in my computer science program I had to write one and it could barely run the rudimentary queries it needed to pass the class. These databases are powering everything around you and munging through petabytes of data at scale.</p>
<p>Frequently these databases can accommodate these queries without any sort of additional configurations; out of the box they&#39;re very fast and flexible. However sometimes you&#39;ll run into some performance issues for various different reasons. The queries will either be very slow, will cause a lot of load on the server running, make the server run unreliably, or even all of the above. In these cases <strong>indexes</strong> can help you. Indexes are a separate data structure that a database maintains so that it can find things quickly. The tradeoff here is that indexes can cause inserts, updates, and deletes to be a bit slower because they also have to update indexes as well as they just take up more room on disk. But in exchange you get very fast queries as well as some other neat properties we&#39;ll explore like enforcing unique keys.</p>
<h2>Explain</h2>
<p>Let&#39;s start by saying I&#39;m definitely not an a DBA, a database admin or a database architect depending on who you ask. There are people whose entire jobs are doing things like this: knowing how to optimize databases to fit usecases. Instead, I&#39;m going to walk you through a few use cases and show you the tools I know to probe for better solutions. From there it&#39;s best to work with people who have a deep knowledge of what you&#39;re trying to.</p>
<p>Consider this fairly simple query:</p>
<pre><code class="hljs language-javascript">db.<span class="hljs-property">pets</span>.<span class="hljs-title function_">find</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Fido&quot;</span> });
</code></pre><p>Pretty simple: find all pets named Fido. However this query does a really dastardly thing: it will actually cause the database to look at <strong>every single record</strong> in the database. For us toying around on our computer this isn&#39;t a big deal but if you&#39;re running this a lot in production this going to be very expensive and fragile. In this case, it&#39;d be much more helpful if there was an index to help us. Let&#39;s first see what explain can tell us.</p>
<pre><code class="hljs language-javascript">db.<span class="hljs-property">pets</span>.<span class="hljs-title function_">find</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Fido&quot;</span> }).<span class="hljs-title function_">explain</span>(<span class="hljs-string">&quot;executionStats&quot;</span>);
</code></pre><p>The two things to notice here are the strategy it used to do our query and how many records it looked at. In this case it looks at <em>every</em> record in our database and it used a <code>COLLSCAN</code> strategy which is the same as a linear search aka O(n) search. Not good! Let&#39;s build an index to make this work a lot better!</p>
<h2>Create an Index</h2>
<pre><code class="hljs language-javascript">db.<span class="hljs-property">pets</span>.<span class="hljs-title function_">createIndex</span>({ <span class="hljs-attr">name</span>: <span class="hljs-number">1</span> });
db.<span class="hljs-property">pets</span>.<span class="hljs-title function_">find</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Fido&quot;</span> }).<span class="hljs-title function_">explain</span>(<span class="hljs-string">&quot;executionStats&quot;</span>);
db.<span class="hljs-property">pets</span>.<span class="hljs-title function_">find</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Fido&quot;</span> }).<span class="hljs-title function_">count</span>();
db.<span class="hljs-property">pets</span>.<span class="hljs-title function_">getIndexes</span>();
</code></pre><p>Notice that it went faster. In my case the speedup was about 300%. Then notice that the number of records examined is the same number as the count. Lastly you can always inspect what indexes exist using getIndexes.</p>
<h2>Compound Indexes</h2>
<p>If you are frequently using two keys together, like type and breed for example, you could consider using a compound index. This will make an index of those two things together. In the specific case that you are querying with those things together it will perform better than two separate indexes of the two things. Since this isn&#39;t meant to be an in-depth treatise of indexes, I&#39;ll let you explore that when you need it.</p>
<h2>Unique Indexes</h2>
<p>Frequently you want to enforce uniqueness on one of the fields in your database. A good example is that an email in your user database should be unique i.e. a user should not be able to sign up twice with the same email address. Our database of pets doesn&#39;t really have a good use case for a unique index but let&#39;s do one on index to show you how to make one. Since <code>_id</code> already exists it&#39;s a redundant to make another number unique index.</p>
<pre><code class="hljs language-javascript">db.<span class="hljs-property">pets</span>.<span class="hljs-title function_">createIndex</span>({ <span class="hljs-attr">index</span>: <span class="hljs-number">1</span> }, { <span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span> });
</code></pre><p>If you get an error like the one below, run a deleteOne on the duplicate key to drop one of them and then try again.</p>
<pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;ok&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;errmsg&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Index build failed: 681332bb-c753-45fb-80c2-00ef2ec1a4e7: Collection test.pets ( 2aa18781-33ae-4aa8-846b-934594558b72 ) :: caused by :: E11000 duplicate key error collection: test.pets index: index_1 dup key: { index: 10000.0 }&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">11000</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;codeName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;DuplicateKey&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;keyPattern&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;keyValue&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10000</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre><p>Once you have it indexed try this query:</p>
<pre><code class="hljs language-javascript">db.<span class="hljs-property">pets</span>.<span class="hljs-title function_">insertOne</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Doggo&quot;</span>, <span class="hljs-attr">index</span>: <span class="hljs-number">10</span> });
</code></pre><p>Now this will fail because 10 already exists. As a bonus, now <code>index</code> is indexed so can easily query by it.</p>
<pre><code class="hljs language-javascript">db.<span class="hljs-property">pets</span>.<span class="hljs-title function_">find</span>({ <span class="hljs-attr">index</span>: <span class="hljs-number">1337</span> }).<span class="hljs-title function_">explain</span>(<span class="hljs-string">&quot;executionStats&quot;</span>);
</code></pre><p>Notice it only looks at one record!</p>
<h2>Text Index</h2>
<p>Frequently something you want to do is called &quot;full text search.&quot; This is the similar to what happens you search Google for something: you want it to drop &quot;stop words&quot; (things like a, the, and, etc.) and you want it to fuzzy match things. Like if I was searching for &quot;Luna Havanese dog&quot; I&#39;d expect to match all dogs named Luna that are Havanese.</p>
<p>First of all, this is directly possible in MongoDB (it used to not be.) However there is entire style of database that does this for you, called search engines. <a href="https://lucene.apache.org/solr/">Apache Solr</a> is the one I used to use at my old job. There are tradeoffs and things that a full separate server can do for you that MongoDB can&#39;t. And you can scale them separately which can be helpful.</p>
<p>So in MongoDB you&#39;ll create a text index. Each collection can only have one text index so make sure you&#39;re indexing all the fields you want to in the one you choose. In our case let&#39;s index type, breed, and name.</p>
<p>Also bears mentioning that by default it does text search in English. It&#39;s possible to set it to other languages or no language at all. <a href="https://docs.mongodb.com/manual/tutorial/specify-language-for-text-index/">See here</a>.</p>
<pre><code class="hljs language-javascript">db.<span class="hljs-property">pets</span>.<span class="hljs-title function_">createIndex</span>({
  <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;text&quot;</span>,
  <span class="hljs-attr">breed</span>: <span class="hljs-string">&quot;text&quot;</span>,
  <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;text&quot;</span>,
});
</code></pre><p>Okay, so now we&#39;ve indexed it, how do we search it? You&#39;ll use a special $text operator.</p>
<pre><code class="hljs language-javascript">db.<span class="hljs-property">pets</span>.<span class="hljs-title function_">find</span>({ <span class="hljs-attr">$text</span>: { <span class="hljs-attr">$search</span>: <span class="hljs-string">&quot;dog Havanese Luna&quot;</span> } });
</code></pre><p>Okay, so notice this is doing an &quot;any&quot; match and not sorting on the most accurate score. Frequently this isn&#39;t what you want: you want the thing that matches most closely with your search terms. We can do that, it just doesn&#39;t do that by default.</p>
<pre><code class="hljs language-javascript">db.<span class="hljs-property">pets</span>
  .<span class="hljs-title function_">find</span>({ <span class="hljs-attr">$text</span>: { <span class="hljs-attr">$search</span>: <span class="hljs-string">&quot;dog Havanese Luna&quot;</span> } })
  .<span class="hljs-title function_">sort</span>({ <span class="hljs-attr">score</span>: { <span class="hljs-attr">$meta</span>: <span class="hljs-string">&quot;textScore&quot;</span> } });
</code></pre><p>This will now send you back the ones that most closely resemble what you&#39;re looking for. If you want to see the actual text scores, here&#39;s how you can see them.</p>
<pre><code class="hljs language-javascript">db.<span class="hljs-property">pets</span>
  .<span class="hljs-title function_">find</span>(
    { <span class="hljs-attr">$text</span>: { <span class="hljs-attr">$search</span>: <span class="hljs-string">&quot;dog Havanese Luna&quot;</span> } },
    { <span class="hljs-attr">score</span>: { <span class="hljs-attr">$meta</span>: <span class="hljs-string">&quot;textScore&quot;</span> } }
  )
  .<span class="hljs-title function_">sort</span>({ <span class="hljs-attr">score</span>: { <span class="hljs-attr">$meta</span>: <span class="hljs-string">&quot;textScore&quot;</span> } });
</code></pre><p>One more note, the <code>&quot;&quot;</code> and <code>-</code> operators from Google do work here. If you want to search for all Lunas that are not cats you can do this:</p>
<pre><code class="hljs language-javascript">db.<span class="hljs-property">pets</span>
  .<span class="hljs-title function_">find</span>({ <span class="hljs-attr">$text</span>: { <span class="hljs-attr">$search</span>: <span class="hljs-string">&quot;-cat Luna&quot;</span> } })
  .<span class="hljs-title function_">sort</span>({ <span class="hljs-attr">score</span>: { <span class="hljs-attr">$meta</span>: <span class="hljs-string">&quot;textScore&quot;</span> } });
</code></pre><p>There&#39;s more to the $text search operator which I&#39;ll leave you to explore. <a href="https://docs.mongodb.com/manual/reference/operator/query/text/index.html">See here</a>.</p>
</div><div class="lesson-links"><a class="prev" href="/lessons/nosql/updating-mongodb">← Previous</a><a class="next" href="/lessons/nosql/aggregation">Next →</a></div></div><div class="details-bg"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="154" height="154" viewBox="0 0 154 154"><defs><clipPath id="clip-path"><rect id="Rectangle_2238" data-name="Rectangle 2238" width="154" height="154" transform="translate(9467 350)" fill="#fff" stroke="#707070" stroke-width="1"></rect></clipPath><clipPath id="clip-corner-image-active"><rect width="154" height="154"></rect></clipPath></defs><g id="corner-image-active" clip-path="url(#clip-corner-image-active)"><g id="Corner-image-active-2" data-name="Corner-image-active" transform="translate(-9467 -350)" clip-path="url(#clip-path)"><path id="Subtraction_34" data-name="Subtraction 34" d="M-3857.365,1740.766h0l-7.07-7.07,12.89-12.89v14.142l-5.818,5.818Zm-14.142-14.142h0l-7.071-7.07,27.033-27.033v14.143l-19.96,19.96Zm-14.143-14.143h0l-7.07-7.069,41.175-41.175v14.142Zm-14.142-14.142h0l-7.07-7.069,55.317-55.317v14.142Zm-14.142-14.142h0l-7.07-7.069,69.459-69.459v14.142Zm-14.142-14.142h0l-7.07-7.069,76.739-76.739h6.862v7.28Zm-14.143-14.143h0l-7.07-7.069,62.6-62.6h14.142Zm-14.142-14.142h0l-7.07-7.069,48.454-48.454h14.142Zm-14.142-14.142h0l-7.07-7.069,34.312-34.312h14.142Zm-14.142-14.142h0l-7.07-7.069,20.17-20.17h14.142Zm-14.142-14.142h0l-7.071-7.071,6.027-6.027h14.144l-13.1,13.1Zm367.24-56.114v-.909l.455.455-.453.453Z" transform="translate(13472.546 -1236.766)" fill="var(--corner-fill)"></path></g></g></svg></div></div></div></div><footer class="footer"><ul class="socials"><li class="social"><a href="https://twitter.com/holtbt"><svg fill="none" height="100%" width="32" xmlns="http://www.w3.org/2000/svg" viewBox="0.254 0.25 500 451.95400000000006"><path d="M394.033.25h76.67L303.202 191.693l197.052 260.511h-154.29L225.118 294.205 86.844 452.204H10.127l179.16-204.77L.254.25H158.46l109.234 144.417zm-26.908 406.063h42.483L135.377 43.73h-45.59z" fill="var(--footer-icons)"></path></svg></a></li><li class="social"><a href="https://bsky.app/profile/brianholt.me"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -3.268 64 68.414" width="38" height="100%"><path fill="var(--footer-icons)" d="M13.873 3.805C21.21 9.332 29.103 20.537 32 26.55v15.882c0-.338-.13.044-.41.867-1.512 4.456-7.418 21.847-20.923 7.944-7.111-7.32-3.819-14.64 9.125-16.85-7.405 1.264-15.73-.825-18.014-9.015C1.12 23.022 0 8.51 0 6.55 0-3.268 8.579-.182 13.873 3.805zm36.254 0C42.79 9.332 34.897 20.537 32 26.55v15.882c0-.338.13.044.41.867 1.512 4.456 7.418 21.847 20.923 7.944 7.111-7.32 3.819-14.64-9.125-16.85 7.405 1.264 15.73-.825 18.014-9.015C62.88 23.022 64 8.51 64 6.55c0-9.818-8.578-6.732-13.873-2.745z"></path></svg></a></li><li class="social"><a href="https://github.com/btholt"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 32 32"><defs><clipPath id="clip-github-social"><rect width="32" height="32"></rect></clipPath></defs><g id="github-social" clip-path="url(#clip-github-social)"><g id="Group_272" data-name="Group 272" transform="translate(13522.5 -6994)"><path id="Subtraction_33" data-name="Subtraction 33" d="M-24967.5,8041a15.9,15.9,0,0,1-11.312-4.688A15.893,15.893,0,0,1-24983.5,8025a15.893,15.893,0,0,1,4.689-11.315A15.894,15.894,0,0,1-24967.5,8009a15.894,15.894,0,0,1,11.313,4.686A15.893,15.893,0,0,1-24951.5,8025a15.893,15.893,0,0,1-4.689,11.313A15.9,15.9,0,0,1-24967.5,8041Zm-3.781-4.571h0v3.918h7.895v-6.665a1.836,1.836,0,0,0-1.2-1.718c5.1-.617,7.467-2.975,7.467-7.424a7.176,7.176,0,0,0-1.637-4.728,6.74,6.74,0,0,0,.275-1.812,4.34,4.34,0,0,0-.52-2.452.574.574,0,0,0-.359-.1c-1.061,0-3.465,1.411-3.936,1.694a16.644,16.644,0,0,0-4.2-.489,16.379,16.379,0,0,0-3.969.445c-.846-.5-2.91-1.649-3.859-1.649a.566.566,0,0,0-.354.095,4.3,4.3,0,0,0-.521,2.452,6.7,6.7,0,0,0,.244,1.718,7.346,7.346,0,0,0-1.6,4.822,7.263,7.263,0,0,0,1.533,4.985c1.193,1.359,3.115,2.165,5.871,2.464a1.826,1.826,0,0,0-1.129,1.693v.5h0l-.006,0a7.121,7.121,0,0,1-2.033.363,2.608,2.608,0,0,1-.965-.158,4.438,4.438,0,0,1-1.836-1.881,2.361,2.361,0,0,0-1.248-1.091,3.472,3.472,0,0,0-1.217-.3.584.584,0,0,0-.545.224.282.282,0,0,0,.027.367,1.875,1.875,0,0,0,.447.307,4.732,4.732,0,0,1,.561.355,10.726,10.726,0,0,1,1.682,2.755c.043.092.078.163.105.217a3.876,3.876,0,0,0,2.42,1.185,6.036,6.036,0,0,0,.607.025c.875,0,1.988-.124,2-.125Z" transform="translate(11461 -1015)" fill="var(--footer-icons)"></path><g id="Ellipse_670" data-name="Ellipse 670" transform="translate(-13522.5 6994)" fill="none" stroke="var(--footer-icons)" stroke-width="1"><circle cx="16" cy="16" r="16" stroke="none"></circle><circle cx="16" cy="16" r="15.5" fill="none"></circle></g></g></g></svg></a></li><li class="social"><a href="https://linkedin.com/in/btholt"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 32 32"><defs><clipPath id="clip-linkedin-social"><rect width="32" height="32"></rect></clipPath></defs><g id="linkedin-social" clip-path="url(#clip-linkedin-social)"><g id="Group_270" data-name="Group 270" transform="translate(-86.349 -633.073)"><path id="Path_375" data-name="Path 375" d="M115.789,633.073a2.324,2.324,0,0,1,1.682.676,2.194,2.194,0,0,1,.695,1.627V662.8a2.131,2.131,0,0,1-.695,1.609,2.314,2.314,0,0,1-1.646.659H88.69a2.307,2.307,0,0,1-1.646-.659,2.128,2.128,0,0,1-.695-1.609V635.376a2.19,2.19,0,0,1,.695-1.627,2.322,2.322,0,0,1,1.682-.676h27.063Zm-20.224,9.672a2.561,2.561,0,0,0,0-3.584,2.658,2.658,0,0,0-1.938-.712,2.724,2.724,0,0,0-1.957.712,2.371,2.371,0,0,0-.75,1.792,2.4,2.4,0,0,0,.731,1.792,2.605,2.605,0,0,0,1.9.713h.037A2.7,2.7,0,0,0,95.565,642.745ZM96,645.434H91.213V659.88H96Zm17.3,6.144a7.007,7.007,0,0,0-1.573-4.9,5.68,5.68,0,0,0-6.839-.769,5.663,5.663,0,0,0-1.426,1.573v-2.048H98.674q.036.841,0,7.717v6.728h4.791V651.8a3.592,3.592,0,0,1,.146-1.17,2.913,2.913,0,0,1,.878-1.206,2.429,2.429,0,0,1,1.609-.549,2.108,2.108,0,0,1,1.865.914,4.265,4.265,0,0,1,.549,2.341v7.752H113.3Z" fill="var(--footer-icons)"></path></g></g></svg></a></li><li class="social"><div class="terms"><p>Content Licensed Under CC-BY-NC-4.0</p><p>Code Samples and Exercises Licensed Under Apache 2.0</p><p>Site Designed by<!-- --> <a href="https://www.alexdanielson.com/">Alex Danielson</a></p></div></li></ul><div class="theme-icons"><button aria-label="Activate dark mode" title="Activate dark mode" class="theme-toggle"><svg xmlns="http://www.w3.org/2000/svg" width="36px" height="100%" viewBox="0 -960 960 960" fill="var(--text-footer)" role="img"><title>Dark Mode Icon</title><path d="M480-120q-150 0-255-105T120-480q0-150 105-255t255-105q14 0 27.5 1t26.5 3q-41 29-65.5 75.5T444-660q0 90 63 153t153 63q55 0 101-24.5t75-65.5q2 13 3 26.5t1 27.5q0 150-105 255T480-120Zm0-80q88 0 158-48.5T740-375q-20 5-40 8t-40 3q-123 0-209.5-86.5T364-660q0-20 3-40t8-40q-78 32-126.5 102T200-480q0 116 82 198t198 82Z"></path></svg></button></div></footer></div><noscript><img src="https://a.holt.courses/noscript.gif" alt="" referrerPolicy="no-referrer-when-downgrade"/></noscript></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"attributes":{"description":"When querying against MongoDB, query performance can be very important. Brian shows you how to think about indexing a MongoDB database to improve performance and capabilities."},"html":"\u003cp\u003eDatabases are honestly marvels of technology. I remember in my computer science program I had to write one and it could barely run the rudimentary queries it needed to pass the class. These databases are powering everything around you and munging through petabytes of data at scale.\u003c/p\u003e\n\u003cp\u003eFrequently these databases can accommodate these queries without any sort of additional configurations; out of the box they\u0026#39;re very fast and flexible. However sometimes you\u0026#39;ll run into some performance issues for various different reasons. The queries will either be very slow, will cause a lot of load on the server running, make the server run unreliably, or even all of the above. In these cases \u003cstrong\u003eindexes\u003c/strong\u003e can help you. Indexes are a separate data structure that a database maintains so that it can find things quickly. The tradeoff here is that indexes can cause inserts, updates, and deletes to be a bit slower because they also have to update indexes as well as they just take up more room on disk. But in exchange you get very fast queries as well as some other neat properties we\u0026#39;ll explore like enforcing unique keys.\u003c/p\u003e\n\u003ch2\u003eExplain\u003c/h2\u003e\n\u003cp\u003eLet\u0026#39;s start by saying I\u0026#39;m definitely not an a DBA, a database admin or a database architect depending on who you ask. There are people whose entire jobs are doing things like this: knowing how to optimize databases to fit usecases. Instead, I\u0026#39;m going to walk you through a few use cases and show you the tools I know to probe for better solutions. From there it\u0026#39;s best to work with people who have a deep knowledge of what you\u0026#39;re trying to.\u003c/p\u003e\n\u003cp\u003eConsider this fairly simple query:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003edb.\u003cspan class=\"hljs-property\"\u003epets\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003efind\u003c/span\u003e({ \u003cspan class=\"hljs-attr\"\u003ename\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;Fido\u0026quot;\u003c/span\u003e });\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003ePretty simple: find all pets named Fido. However this query does a really dastardly thing: it will actually cause the database to look at \u003cstrong\u003eevery single record\u003c/strong\u003e in the database. For us toying around on our computer this isn\u0026#39;t a big deal but if you\u0026#39;re running this a lot in production this going to be very expensive and fragile. In this case, it\u0026#39;d be much more helpful if there was an index to help us. Let\u0026#39;s first see what explain can tell us.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003edb.\u003cspan class=\"hljs-property\"\u003epets\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003efind\u003c/span\u003e({ \u003cspan class=\"hljs-attr\"\u003ename\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;Fido\u0026quot;\u003c/span\u003e }).\u003cspan class=\"hljs-title function_\"\u003eexplain\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;executionStats\u0026quot;\u003c/span\u003e);\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThe two things to notice here are the strategy it used to do our query and how many records it looked at. In this case it looks at \u003cem\u003eevery\u003c/em\u003e record in our database and it used a \u003ccode\u003eCOLLSCAN\u003c/code\u003e strategy which is the same as a linear search aka O(n) search. Not good! Let\u0026#39;s build an index to make this work a lot better!\u003c/p\u003e\n\u003ch2\u003eCreate an Index\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003edb.\u003cspan class=\"hljs-property\"\u003epets\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ecreateIndex\u003c/span\u003e({ \u003cspan class=\"hljs-attr\"\u003ename\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e });\ndb.\u003cspan class=\"hljs-property\"\u003epets\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003efind\u003c/span\u003e({ \u003cspan class=\"hljs-attr\"\u003ename\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;Fido\u0026quot;\u003c/span\u003e }).\u003cspan class=\"hljs-title function_\"\u003eexplain\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;executionStats\u0026quot;\u003c/span\u003e);\ndb.\u003cspan class=\"hljs-property\"\u003epets\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003efind\u003c/span\u003e({ \u003cspan class=\"hljs-attr\"\u003ename\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;Fido\u0026quot;\u003c/span\u003e }).\u003cspan class=\"hljs-title function_\"\u003ecount\u003c/span\u003e();\ndb.\u003cspan class=\"hljs-property\"\u003epets\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003egetIndexes\u003c/span\u003e();\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eNotice that it went faster. In my case the speedup was about 300%. Then notice that the number of records examined is the same number as the count. Lastly you can always inspect what indexes exist using getIndexes.\u003c/p\u003e\n\u003ch2\u003eCompound Indexes\u003c/h2\u003e\n\u003cp\u003eIf you are frequently using two keys together, like type and breed for example, you could consider using a compound index. This will make an index of those two things together. In the specific case that you are querying with those things together it will perform better than two separate indexes of the two things. Since this isn\u0026#39;t meant to be an in-depth treatise of indexes, I\u0026#39;ll let you explore that when you need it.\u003c/p\u003e\n\u003ch2\u003eUnique Indexes\u003c/h2\u003e\n\u003cp\u003eFrequently you want to enforce uniqueness on one of the fields in your database. A good example is that an email in your user database should be unique i.e. a user should not be able to sign up twice with the same email address. Our database of pets doesn\u0026#39;t really have a good use case for a unique index but let\u0026#39;s do one on index to show you how to make one. Since \u003ccode\u003e_id\u003c/code\u003e already exists it\u0026#39;s a redundant to make another number unique index.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003edb.\u003cspan class=\"hljs-property\"\u003epets\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ecreateIndex\u003c/span\u003e({ \u003cspan class=\"hljs-attr\"\u003eindex\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e }, { \u003cspan class=\"hljs-attr\"\u003eunique\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e });\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eIf you get an error like the one below, run a deleteOne on the duplicate key to drop one of them and then try again.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-json\"\u003e\u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003e\u0026quot;ok\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003e\u0026quot;errmsg\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;Index build failed: 681332bb-c753-45fb-80c2-00ef2ec1a4e7: Collection test.pets ( 2aa18781-33ae-4aa8-846b-934594558b72 ) :: caused by :: E11000 duplicate key error collection: test.pets index: index_1 dup key: { index: 10000.0 }\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003e\u0026quot;code\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e11000\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003e\u0026quot;codeName\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;DuplicateKey\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003e\u0026quot;keyPattern\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\u0026quot;index\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\n  \u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003e\u0026quot;keyValue\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\u0026quot;index\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e10000\u003c/span\u003e\n  \u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eOnce you have it indexed try this query:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003edb.\u003cspan class=\"hljs-property\"\u003epets\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003einsertOne\u003c/span\u003e({ \u003cspan class=\"hljs-attr\"\u003ename\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;Doggo\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-attr\"\u003eindex\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e });\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eNow this will fail because 10 already exists. As a bonus, now \u003ccode\u003eindex\u003c/code\u003e is indexed so can easily query by it.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003edb.\u003cspan class=\"hljs-property\"\u003epets\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003efind\u003c/span\u003e({ \u003cspan class=\"hljs-attr\"\u003eindex\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e1337\u003c/span\u003e }).\u003cspan class=\"hljs-title function_\"\u003eexplain\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;executionStats\u0026quot;\u003c/span\u003e);\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eNotice it only looks at one record!\u003c/p\u003e\n\u003ch2\u003eText Index\u003c/h2\u003e\n\u003cp\u003eFrequently something you want to do is called \u0026quot;full text search.\u0026quot; This is the similar to what happens you search Google for something: you want it to drop \u0026quot;stop words\u0026quot; (things like a, the, and, etc.) and you want it to fuzzy match things. Like if I was searching for \u0026quot;Luna Havanese dog\u0026quot; I\u0026#39;d expect to match all dogs named Luna that are Havanese.\u003c/p\u003e\n\u003cp\u003eFirst of all, this is directly possible in MongoDB (it used to not be.) However there is entire style of database that does this for you, called search engines. \u003ca href=\"https://lucene.apache.org/solr/\"\u003eApache Solr\u003c/a\u003e is the one I used to use at my old job. There are tradeoffs and things that a full separate server can do for you that MongoDB can\u0026#39;t. And you can scale them separately which can be helpful.\u003c/p\u003e\n\u003cp\u003eSo in MongoDB you\u0026#39;ll create a text index. Each collection can only have one text index so make sure you\u0026#39;re indexing all the fields you want to in the one you choose. In our case let\u0026#39;s index type, breed, and name.\u003c/p\u003e\n\u003cp\u003eAlso bears mentioning that by default it does text search in English. It\u0026#39;s possible to set it to other languages or no language at all. \u003ca href=\"https://docs.mongodb.com/manual/tutorial/specify-language-for-text-index/\"\u003eSee here\u003c/a\u003e.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003edb.\u003cspan class=\"hljs-property\"\u003epets\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ecreateIndex\u003c/span\u003e({\n  \u003cspan class=\"hljs-attr\"\u003etype\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;text\u0026quot;\u003c/span\u003e,\n  \u003cspan class=\"hljs-attr\"\u003ebreed\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;text\u0026quot;\u003c/span\u003e,\n  \u003cspan class=\"hljs-attr\"\u003ename\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;text\u0026quot;\u003c/span\u003e,\n});\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eOkay, so now we\u0026#39;ve indexed it, how do we search it? You\u0026#39;ll use a special $text operator.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003edb.\u003cspan class=\"hljs-property\"\u003epets\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003efind\u003c/span\u003e({ \u003cspan class=\"hljs-attr\"\u003e$text\u003c/span\u003e: { \u003cspan class=\"hljs-attr\"\u003e$search\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;dog Havanese Luna\u0026quot;\u003c/span\u003e } });\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eOkay, so notice this is doing an \u0026quot;any\u0026quot; match and not sorting on the most accurate score. Frequently this isn\u0026#39;t what you want: you want the thing that matches most closely with your search terms. We can do that, it just doesn\u0026#39;t do that by default.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003edb.\u003cspan class=\"hljs-property\"\u003epets\u003c/span\u003e\n  .\u003cspan class=\"hljs-title function_\"\u003efind\u003c/span\u003e({ \u003cspan class=\"hljs-attr\"\u003e$text\u003c/span\u003e: { \u003cspan class=\"hljs-attr\"\u003e$search\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;dog Havanese Luna\u0026quot;\u003c/span\u003e } })\n  .\u003cspan class=\"hljs-title function_\"\u003esort\u003c/span\u003e({ \u003cspan class=\"hljs-attr\"\u003escore\u003c/span\u003e: { \u003cspan class=\"hljs-attr\"\u003e$meta\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;textScore\u0026quot;\u003c/span\u003e } });\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThis will now send you back the ones that most closely resemble what you\u0026#39;re looking for. If you want to see the actual text scores, here\u0026#39;s how you can see them.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003edb.\u003cspan class=\"hljs-property\"\u003epets\u003c/span\u003e\n  .\u003cspan class=\"hljs-title function_\"\u003efind\u003c/span\u003e(\n    { \u003cspan class=\"hljs-attr\"\u003e$text\u003c/span\u003e: { \u003cspan class=\"hljs-attr\"\u003e$search\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;dog Havanese Luna\u0026quot;\u003c/span\u003e } },\n    { \u003cspan class=\"hljs-attr\"\u003escore\u003c/span\u003e: { \u003cspan class=\"hljs-attr\"\u003e$meta\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;textScore\u0026quot;\u003c/span\u003e } }\n  )\n  .\u003cspan class=\"hljs-title function_\"\u003esort\u003c/span\u003e({ \u003cspan class=\"hljs-attr\"\u003escore\u003c/span\u003e: { \u003cspan class=\"hljs-attr\"\u003e$meta\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;textScore\u0026quot;\u003c/span\u003e } });\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eOne more note, the \u003ccode\u003e\u0026quot;\u0026quot;\u003c/code\u003e and \u003ccode\u003e-\u003c/code\u003e operators from Google do work here. If you want to search for all Lunas that are not cats you can do this:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003edb.\u003cspan class=\"hljs-property\"\u003epets\u003c/span\u003e\n  .\u003cspan class=\"hljs-title function_\"\u003efind\u003c/span\u003e({ \u003cspan class=\"hljs-attr\"\u003e$text\u003c/span\u003e: { \u003cspan class=\"hljs-attr\"\u003e$search\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;-cat Luna\u0026quot;\u003c/span\u003e } })\n  .\u003cspan class=\"hljs-title function_\"\u003esort\u003c/span\u003e({ \u003cspan class=\"hljs-attr\"\u003escore\u003c/span\u003e: { \u003cspan class=\"hljs-attr\"\u003e$meta\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;textScore\u0026quot;\u003c/span\u003e } });\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThere\u0026#39;s more to the $text search operator which I\u0026#39;ll leave you to explore. \u003ca href=\"https://docs.mongodb.com/manual/reference/operator/query/text/index.html\"\u003eSee here\u003c/a\u003e.\u003c/p\u003e\n","markdown":"\nDatabases are honestly marvels of technology. I remember in my computer science program I had to write one and it could barely run the rudimentary queries it needed to pass the class. These databases are powering everything around you and munging through petabytes of data at scale.\n\nFrequently these databases can accommodate these queries without any sort of additional configurations; out of the box they're very fast and flexible. However sometimes you'll run into some performance issues for various different reasons. The queries will either be very slow, will cause a lot of load on the server running, make the server run unreliably, or even all of the above. In these cases **indexes** can help you. Indexes are a separate data structure that a database maintains so that it can find things quickly. The tradeoff here is that indexes can cause inserts, updates, and deletes to be a bit slower because they also have to update indexes as well as they just take up more room on disk. But in exchange you get very fast queries as well as some other neat properties we'll explore like enforcing unique keys.\n\n## Explain\n\nLet's start by saying I'm definitely not an a DBA, a database admin or a database architect depending on who you ask. There are people whose entire jobs are doing things like this: knowing how to optimize databases to fit usecases. Instead, I'm going to walk you through a few use cases and show you the tools I know to probe for better solutions. From there it's best to work with people who have a deep knowledge of what you're trying to.\n\nConsider this fairly simple query:\n\n```javascript\ndb.pets.find({ name: \"Fido\" });\n```\n\nPretty simple: find all pets named Fido. However this query does a really dastardly thing: it will actually cause the database to look at **every single record** in the database. For us toying around on our computer this isn't a big deal but if you're running this a lot in production this going to be very expensive and fragile. In this case, it'd be much more helpful if there was an index to help us. Let's first see what explain can tell us.\n\n```javascript\ndb.pets.find({ name: \"Fido\" }).explain(\"executionStats\");\n```\n\nThe two things to notice here are the strategy it used to do our query and how many records it looked at. In this case it looks at _every_ record in our database and it used a `COLLSCAN` strategy which is the same as a linear search aka O(n) search. Not good! Let's build an index to make this work a lot better!\n\n## Create an Index\n\n```javascript\ndb.pets.createIndex({ name: 1 });\ndb.pets.find({ name: \"Fido\" }).explain(\"executionStats\");\ndb.pets.find({ name: \"Fido\" }).count();\ndb.pets.getIndexes();\n```\n\nNotice that it went faster. In my case the speedup was about 300%. Then notice that the number of records examined is the same number as the count. Lastly you can always inspect what indexes exist using getIndexes.\n\n## Compound Indexes\n\nIf you are frequently using two keys together, like type and breed for example, you could consider using a compound index. This will make an index of those two things together. In the specific case that you are querying with those things together it will perform better than two separate indexes of the two things. Since this isn't meant to be an in-depth treatise of indexes, I'll let you explore that when you need it.\n\n## Unique Indexes\n\nFrequently you want to enforce uniqueness on one of the fields in your database. A good example is that an email in your user database should be unique i.e. a user should not be able to sign up twice with the same email address. Our database of pets doesn't really have a good use case for a unique index but let's do one on index to show you how to make one. Since `_id` already exists it's a redundant to make another number unique index.\n\n```javascript\ndb.pets.createIndex({ index: 1 }, { unique: true });\n```\n\nIf you get an error like the one below, run a deleteOne on the duplicate key to drop one of them and then try again.\n\n```json\n{\n  \"ok\": 0,\n  \"errmsg\": \"Index build failed: 681332bb-c753-45fb-80c2-00ef2ec1a4e7: Collection test.pets ( 2aa18781-33ae-4aa8-846b-934594558b72 ) :: caused by :: E11000 duplicate key error collection: test.pets index: index_1 dup key: { index: 10000.0 }\",\n  \"code\": 11000,\n  \"codeName\": \"DuplicateKey\",\n  \"keyPattern\": {\n    \"index\": 1\n  },\n  \"keyValue\": {\n    \"index\": 10000\n  }\n}\n```\n\nOnce you have it indexed try this query:\n\n```javascript\ndb.pets.insertOne({ name: \"Doggo\", index: 10 });\n```\n\nNow this will fail because 10 already exists. As a bonus, now `index` is indexed so can easily query by it.\n\n```javascript\ndb.pets.find({ index: 1337 }).explain(\"executionStats\");\n```\n\nNotice it only looks at one record!\n\n## Text Index\n\nFrequently something you want to do is called \"full text search.\" This is the similar to what happens you search Google for something: you want it to drop \"stop words\" (things like a, the, and, etc.) and you want it to fuzzy match things. Like if I was searching for \"Luna Havanese dog\" I'd expect to match all dogs named Luna that are Havanese.\n\nFirst of all, this is directly possible in MongoDB (it used to not be.) However there is entire style of database that does this for you, called search engines. [Apache Solr][solr] is the one I used to use at my old job. There are tradeoffs and things that a full separate server can do for you that MongoDB can't. And you can scale them separately which can be helpful.\n\nSo in MongoDB you'll create a text index. Each collection can only have one text index so make sure you're indexing all the fields you want to in the one you choose. In our case let's index type, breed, and name.\n\nAlso bears mentioning that by default it does text search in English. It's possible to set it to other languages or no language at all. [See here][text-index].\n\n```javascript\ndb.pets.createIndex({\n  type: \"text\",\n  breed: \"text\",\n  name: \"text\",\n});\n```\n\nOkay, so now we've indexed it, how do we search it? You'll use a special \\$text operator.\n\n```javascript\ndb.pets.find({ $text: { $search: \"dog Havanese Luna\" } });\n```\n\nOkay, so notice this is doing an \"any\" match and not sorting on the most accurate score. Frequently this isn't what you want: you want the thing that matches most closely with your search terms. We can do that, it just doesn't do that by default.\n\n```javascript\ndb.pets\n  .find({ $text: { $search: \"dog Havanese Luna\" } })\n  .sort({ score: { $meta: \"textScore\" } });\n```\n\nThis will now send you back the ones that most closely resemble what you're looking for. If you want to see the actual text scores, here's how you can see them.\n\n```javascript\ndb.pets\n  .find(\n    { $text: { $search: \"dog Havanese Luna\" } },\n    { score: { $meta: \"textScore\" } }\n  )\n  .sort({ score: { $meta: \"textScore\" } });\n```\n\nOne more note, the `\"\"` and `-` operators from Google do work here. If you want to search for all Lunas that are not cats you can do this:\n\n```javascript\ndb.pets\n  .find({ $text: { $search: \"-cat Luna\" } })\n  .sort({ score: { $meta: \"textScore\" } });\n```\n\nThere's more to the \\$text search operator which I'll leave you to explore. [See here][text].\n\n[solr]: https://lucene.apache.org/solr/\n[text-index]: https://docs.mongodb.com/manual/tutorial/specify-language-for-text-index/\n[text]: https://docs.mongodb.com/manual/reference/operator/query/text/index.html\n","slug":"indexes-in-mongodb","title":"Indexes in Mongodb","section":"Nosql","icon":"info-circle","filePath":"/home/runner/work/complete-intro-to-databases-v2/complete-intro-to-databases-v2/lessons/02-nosql/E-indexes-in-mongodb.md","nextSlug":"/lessons/nosql/aggregation","prevSlug":"/lessons/nosql/updating-mongodb"}},"__N_SSG":true},"page":"/lessons/[section]/[slug]","query":{"section":"nosql","slug":"indexes-in-mongodb"},"buildId":"Ogv8p-BwCHRQ1PzRpAU9u","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>