{"pageProps":{"post":{"attributes":{"description":"Indexes are critical to a well functional relational database. Brian quickly explains how to investigate query performance and how to create an index to solve that problem."},"html":"<p>This works very similarily to how it works in MongoDB so we&#39;re going to breeze over this pretty quickly.</p>\n<p>Let&#39;s take this query:</p>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-keyword\">SELECT</span> comment_id, user_id, <span class=\"hljs-type\">time</span>, <span class=\"hljs-keyword\">LEFT</span>(comment, <span class=\"hljs-number\">20</span>) <span class=\"hljs-keyword\">FROM</span> comments <span class=\"hljs-keyword\">WHERE</span> board_id <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">39</span> <span class=\"hljs-keyword\">ORDER</span> <span class=\"hljs-keyword\">BY</span> <span class=\"hljs-type\">time</span> <span class=\"hljs-keyword\">DESC</span> LIMIT <span class=\"hljs-number\">40</span>;\n</code></pre><p>This should be a pretty common query if we&#39;re making a message board: grab all the comments for a particular board. Let&#39;s see what PostgreSQL does under the hood by adding an <code>EXPLAIN</code> in front of it.</p>\n<pre><code class=\"hljs language-sql\">EXPLAIN <span class=\"hljs-keyword\">SELECT</span> comment_id, user_id, <span class=\"hljs-type\">time</span>, <span class=\"hljs-keyword\">LEFT</span>(comment, <span class=\"hljs-number\">20</span>) <span class=\"hljs-keyword\">FROM</span> comments <span class=\"hljs-keyword\">WHERE</span> board_id <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">39</span> <span class=\"hljs-keyword\">ORDER</span> <span class=\"hljs-keyword\">BY</span> <span class=\"hljs-type\">time</span> <span class=\"hljs-keyword\">DESC</span> LIMIT <span class=\"hljs-number\">40</span>;\n</code></pre><p>This part should break your heart: <code>Seq Scan on comments</code>. This means it&#39;s looking at every comment in the table to find the answer. This is a place we&#39;d need an index to prevent this. Let&#39;s make an index on board_ids to speed this up.</p>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-keyword\">CREATE</span> INDEX <span class=\"hljs-keyword\">ON</span> comments (board_id);\nEXPLAIN <span class=\"hljs-keyword\">SELECT</span> comment_id, user_id, <span class=\"hljs-type\">time</span>, <span class=\"hljs-keyword\">LEFT</span>(comment, <span class=\"hljs-number\">20</span>) <span class=\"hljs-keyword\">FROM</span> comments <span class=\"hljs-keyword\">WHERE</span> board_id <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">39</span> <span class=\"hljs-keyword\">ORDER</span> <span class=\"hljs-keyword\">BY</span> <span class=\"hljs-type\">time</span> <span class=\"hljs-keyword\">DESC</span> LIMIT <span class=\"hljs-number\">40</span>; <span class=\"hljs-comment\">-- run again</span>\n</code></pre><p>If you&#39;re looking the EXPLAIN again, you&#39;ll see it does a <code>Bitmap Heap Scan</code> instead of a Seq Scan. Much better!</p>\n<p>Let&#39;s do one more; all users should have a unique username. Let&#39;s ensure that with a unique index.</p>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">UNIQUE</span> INDEX username_idx <span class=\"hljs-keyword\">ON</span> users (username);\n<span class=\"hljs-keyword\">INSERT INTO</span> users (username, email, full_name, created_on) <span class=\"hljs-keyword\">VALUES</span> (<span class=\"hljs-string\">&#x27;aaizikovj&#x27;</span>, <span class=\"hljs-string\">&#x27;lol@example.com&#x27;</span>, <span class=\"hljs-string\">&#x27;Brian Holt&#x27;</span>, NOW()); <span class=\"hljs-comment\">-- this will fail</span>\n</code></pre><ul>\n<li>The <code>username_idx</code> is just a name for the index. You can call it whatever you want.</li>\n<li>Try inserting a duplicate username. The query will fail.</li>\n<li>A pleasant byproduct is that this field is now indexed so you can easily search it.</li>\n</ul>\n<p>PostgreSQL has <a href=\"https://www.postgresql.org/docs/13.0/indexes.html\">more types of indexes</a>. Feel free to explore them more.</p>\n","markdown":"\nThis works very similarily to how it works in MongoDB so we're going to breeze over this pretty quickly.\n\nLet's take this query:\n\n```sql\nSELECT comment_id, user_id, time, LEFT(comment, 20) FROM comments WHERE board_id = 39 ORDER BY time DESC LIMIT 40;\n```\n\nThis should be a pretty common query if we're making a message board: grab all the comments for a particular board. Let's see what PostgreSQL does under the hood by adding an `EXPLAIN` in front of it.\n\n```sql\nEXPLAIN SELECT comment_id, user_id, time, LEFT(comment, 20) FROM comments WHERE board_id = 39 ORDER BY time DESC LIMIT 40;\n```\n\nThis part should break your heart: `Seq Scan on comments`. This means it's looking at every comment in the table to find the answer. This is a place we'd need an index to prevent this. Let's make an index on board_ids to speed this up.\n\n```sql\nCREATE INDEX ON comments (board_id);\nEXPLAIN SELECT comment_id, user_id, time, LEFT(comment, 20) FROM comments WHERE board_id = 39 ORDER BY time DESC LIMIT 40; -- run again\n```\n\nIf you're looking the EXPLAIN again, you'll see it does a `Bitmap Heap Scan` instead of a Seq Scan. Much better!\n\nLet's do one more; all users should have a unique username. Let's ensure that with a unique index.\n\n```sql\nCREATE UNIQUE INDEX username_idx ON users (username);\nINSERT INTO users (username, email, full_name, created_on) VALUES ('aaizikovj', 'lol@example.com', 'Brian Holt', NOW()); -- this will fail\n```\n\n- The `username_idx` is just a name for the index. You can call it whatever you want.\n- Try inserting a duplicate username. The query will fail.\n- A pleasant byproduct is that this field is now indexed so you can easily search it.\n\nPostgreSQL has [more types of indexes][indexes]. Feel free to explore them more.\n\n[indexes]: https://www.postgresql.org/docs/13.0/indexes.html\n","slug":"indexes-in-postgresql","title":"Indexes in Postgresql","section":"Sql","icon":"info-circle","filePath":"/home/runner/work/complete-intro-to-databases-v2/complete-intro-to-databases-v2/lessons/03-sql/F-indexes-in-postgresql.md","nextSlug":"/lessons/sql/nodejs-app-with-postgresql","prevSlug":"/lessons/sql/json-in-postgresql"}},"__N_SSG":true}