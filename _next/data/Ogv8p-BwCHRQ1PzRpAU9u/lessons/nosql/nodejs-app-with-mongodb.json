{"pageProps":{"post":{"attributes":{"title":"Write a Node.js App with MongoDB","description":"Brian shows you a quick project to demonstrate how to translate these command line concepts into code with a Node.js app to query our pets database"},"html":"<p>Let&#39;s quickly write up a quick Node.js project to help you transfer your skills from the command line to the coding world.</p>\n<p><a href=\"https://github.com/btholt/db-samples\">You can access all samples for this project here</a>.</p>\n<p>Make a new directory. In that directory run:</p>\n<pre><code class=\"hljs language-bash\">npm init -y\nnpm i express mongodb@3.6.2 express@4.17.1\n<span class=\"hljs-built_in\">mkdir</span> static\n<span class=\"hljs-built_in\">touch</span> static/index.html server.js\ncode . <span class=\"hljs-comment\"># or open this folder in VS Code or whatever editor you want</span>\n</code></pre><p>Let&#39;s make a dumb front end that just makes search queries against the backend. In static/index.html put:</p>\n<pre><code class=\"hljs language-html\"><span class=\"hljs-meta\">&lt;!DOCTYPE <span class=\"hljs-keyword\">html</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span> <span class=\"hljs-attr\">lang</span>=<span class=\"hljs-string\">&quot;en&quot;</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">meta</span> <span class=\"hljs-attr\">charset</span>=<span class=\"hljs-string\">&quot;UTF-8&quot;</span> /&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">meta</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">&quot;viewport&quot;</span> <span class=\"hljs-attr\">content</span>=<span class=\"hljs-string\">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span>MongoDB Sample<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">input</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">&quot;text&quot;</span> <span class=\"hljs-attr\">placeholder</span>=<span class=\"hljs-string\">&quot;Search&quot;</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">&quot;search&quot;</span> /&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">button</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">&quot;btn&quot;</span>&gt;</span>Search<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">button</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">pre</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">code</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">&quot;code&quot;</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">code</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">pre</span>&gt;</span>\n\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span>&gt;</span><span class=\"language-javascript\">\n      <span class=\"hljs-keyword\">const</span> btn = <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">getElementById</span>(<span class=\"hljs-string\">&quot;btn&quot;</span>);\n      <span class=\"hljs-keyword\">const</span> code = <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">getElementById</span>(<span class=\"hljs-string\">&quot;code&quot;</span>);\n      <span class=\"hljs-keyword\">const</span> search = <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">getElementById</span>(<span class=\"hljs-string\">&quot;search&quot;</span>);\n\n      btn.<span class=\"hljs-title function_\">addEventListener</span>(<span class=\"hljs-string\">&quot;click&quot;</span>, <span class=\"hljs-title function_\">async</span> () =&gt; {\n        code.<span class=\"hljs-property\">innerText</span> = <span class=\"hljs-string\">&quot;loading&quot;</span>;\n\n        <span class=\"hljs-keyword\">const</span> res = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">fetch</span>(\n          <span class=\"hljs-string\">&quot;/get?search=&quot;</span> + <span class=\"hljs-built_in\">encodeURIComponent</span>(search.<span class=\"hljs-property\">value</span>)\n        );\n        <span class=\"hljs-keyword\">const</span> json = <span class=\"hljs-keyword\">await</span> res.<span class=\"hljs-title function_\">json</span>();\n\n        code.<span class=\"hljs-property\">innerText</span> = <span class=\"hljs-string\">&quot;\\n&quot;</span> + <span class=\"hljs-title class_\">JSON</span>.<span class=\"hljs-title function_\">stringify</span>(json, <span class=\"hljs-literal\">null</span>, <span class=\"hljs-number\">4</span>);\n      });\n    </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span>\n</code></pre><p>Normally I&#39;d say don&#39;t put a big script tag in there but we&#39;re going for simplicity right now. You can refactor this later to something better.</p>\n<p>In server.js, put this:</p>\n<pre><code class=\"hljs language-javascript\"><span class=\"hljs-keyword\">const</span> express = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&quot;express&quot;</span>);\n<span class=\"hljs-keyword\">const</span> { <span class=\"hljs-title class_\">MongoClient</span> } = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&quot;mongodb&quot;</span>);\n\n<span class=\"hljs-keyword\">const</span> connectionString =\n  process.<span class=\"hljs-property\">env</span>.<span class=\"hljs-property\">MONGODB_CONNECTION_STRING</span> || <span class=\"hljs-string\">&quot;mongodb://localhost:27017&quot;</span>;\n\n<span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">init</span>(<span class=\"hljs-params\"></span>) {\n  <span class=\"hljs-keyword\">const</span> client = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">MongoClient</span>(connectionString, {\n    <span class=\"hljs-attr\">useUnifiedTopology</span>: <span class=\"hljs-literal\">true</span>,\n  });\n  <span class=\"hljs-keyword\">await</span> client.<span class=\"hljs-title function_\">connect</span>();\n\n  <span class=\"hljs-keyword\">const</span> app = <span class=\"hljs-title function_\">express</span>();\n\n  app.<span class=\"hljs-title function_\">get</span>(<span class=\"hljs-string\">&quot;/get&quot;</span>, <span class=\"hljs-title function_\">async</span> (req, res) =&gt; {\n    <span class=\"hljs-keyword\">const</span> db = <span class=\"hljs-keyword\">await</span> client.<span class=\"hljs-title function_\">db</span>(<span class=\"hljs-string\">&quot;adoption&quot;</span>);\n    <span class=\"hljs-keyword\">const</span> collection = db.<span class=\"hljs-title function_\">collection</span>(<span class=\"hljs-string\">&quot;pets&quot;</span>);\n\n    <span class=\"hljs-keyword\">const</span> pets = <span class=\"hljs-keyword\">await</span> collection\n      .<span class=\"hljs-title function_\">find</span>(\n        {\n          <span class=\"hljs-attr\">$text</span>: { <span class=\"hljs-attr\">$search</span>: req.<span class=\"hljs-property\">query</span>.<span class=\"hljs-property\">search</span> },\n        },\n        { <span class=\"hljs-attr\">_id</span>: <span class=\"hljs-number\">0</span> }\n      )\n      .<span class=\"hljs-title function_\">sort</span>({ <span class=\"hljs-attr\">score</span>: { <span class=\"hljs-attr\">$meta</span>: <span class=\"hljs-string\">&quot;textScore&quot;</span> } })\n      .<span class=\"hljs-title function_\">limit</span>(<span class=\"hljs-number\">10</span>)\n      .<span class=\"hljs-title function_\">toArray</span>();\n\n    res.<span class=\"hljs-title function_\">json</span>({ <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">&quot;ok&quot;</span>, pets }).<span class=\"hljs-title function_\">end</span>();\n  });\n\n  <span class=\"hljs-keyword\">const</span> <span class=\"hljs-variable constant_\">PORT</span> = process.<span class=\"hljs-property\">env</span>.<span class=\"hljs-property\">PORT</span> || <span class=\"hljs-number\">3000</span>;\n  app.<span class=\"hljs-title function_\">use</span>(express.<span class=\"hljs-title function_\">static</span>(<span class=\"hljs-string\">&quot;./static&quot;</span>));\n  app.<span class=\"hljs-title function_\">listen</span>(<span class=\"hljs-variable constant_\">PORT</span>);\n\n  <span class=\"hljs-variable language_\">console</span>.<span class=\"hljs-title function_\">log</span>(<span class=\"hljs-string\">`running on http://localhost:<span class=\"hljs-subst\">${PORT}</span>`</span>);\n}\n<span class=\"hljs-title function_\">init</span>();\n</code></pre><p><strong>Potential problem you may see:</strong> if you&#39;re seeing the error <code>UnhandledPromiseRejectionWarning: MongoError: text index required for $text query (no such collection &#39;adoption.pets&#39;)</code> then you probably have the wrong database name in your code. In my example, I called my database <code>adoption</code>. If you didn&#39;t change the name of your database, it will be called <code>test</code>. If you don&#39;t know the name of your database, run <code>db</code> in your mongo shell and it should tell you. Once you discover the name of your database, change the line <code>const db = await client.db(&quot;&lt;the name of your database here&gt;&quot;);</code> so that it matches the name of your database.</p>\n<p>Let&#39;s go over a few notes here. To be clear, this is mostly to show you how to connect to MongoDB from code and to show you that all those queries that you learned over the last section apply almost without modification (there are some small differences)</p>\n<ul>\n<li>We grab a MongoDB connection string out of an environment variable (so you can do that if it&#39;s running on a server out in the cloud) otherwise it&#39;ll use a local running copy like we will right now.</li>\n<li>You need to connect to the DB, then to a db (database), then to a collection.</li>\n<li>You run all the queries at the collection level</li>\n<li>find, sort, limit, toArray, deleteOne, findOneAndReplace, etc. all work the way you&#39;d expect them to.</li>\n</ul>\n<p>That&#39;s it! That&#39;s a quick Node.js server that connects to MongoDB!</p>\n","markdown":"\nLet's quickly write up a quick Node.js project to help you transfer your skills from the command line to the coding world.\n\n[You can access all samples for this project here][samples].\n\nMake a new directory. In that directory run:\n\n```bash\nnpm init -y\nnpm i express mongodb@3.6.2 express@4.17.1\nmkdir static\ntouch static/index.html server.js\ncode . # or open this folder in VS Code or whatever editor you want\n```\n\nLet's make a dumb front end that just makes search queries against the backend. In static/index.html put:\n\n```html\n<!DOCTYPE html>\n<html lang=\"en\">\n  <head>\n    <meta charset=\"UTF-8\" />\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />\n    <title>MongoDB Sample</title>\n  </head>\n  <body>\n    <input type=\"text\" placeholder=\"Search\" id=\"search\" />\n    <button id=\"btn\">Search</button>\n    <pre>\n        <code id=\"code\"></code>\n    </pre>\n\n    <script>\n      const btn = document.getElementById(\"btn\");\n      const code = document.getElementById(\"code\");\n      const search = document.getElementById(\"search\");\n\n      btn.addEventListener(\"click\", async () => {\n        code.innerText = \"loading\";\n\n        const res = await fetch(\n          \"/get?search=\" + encodeURIComponent(search.value)\n        );\n        const json = await res.json();\n\n        code.innerText = \"\\n\" + JSON.stringify(json, null, 4);\n      });\n    </script>\n  </body>\n</html>\n```\n\nNormally I'd say don't put a big script tag in there but we're going for simplicity right now. You can refactor this later to something better.\n\nIn server.js, put this:\n\n```javascript\nconst express = require(\"express\");\nconst { MongoClient } = require(\"mongodb\");\n\nconst connectionString =\n  process.env.MONGODB_CONNECTION_STRING || \"mongodb://localhost:27017\";\n\nasync function init() {\n  const client = new MongoClient(connectionString, {\n    useUnifiedTopology: true,\n  });\n  await client.connect();\n\n  const app = express();\n\n  app.get(\"/get\", async (req, res) => {\n    const db = await client.db(\"adoption\");\n    const collection = db.collection(\"pets\");\n\n    const pets = await collection\n      .find(\n        {\n          $text: { $search: req.query.search },\n        },\n        { _id: 0 }\n      )\n      .sort({ score: { $meta: \"textScore\" } })\n      .limit(10)\n      .toArray();\n\n    res.json({ status: \"ok\", pets }).end();\n  });\n\n  const PORT = process.env.PORT || 3000;\n  app.use(express.static(\"./static\"));\n  app.listen(PORT);\n\n  console.log(`running on http://localhost:${PORT}`);\n}\ninit();\n```\n\n**Potential problem you may see:** if you're seeing the error `UnhandledPromiseRejectionWarning: MongoError: text index required for $text query (no such collection 'adoption.pets')` then you probably have the wrong database name in your code. In my example, I called my database `adoption`. If you didn't change the name of your database, it will be called `test`. If you don't know the name of your database, run `db` in your mongo shell and it should tell you. Once you discover the name of your database, change the line `const db = await client.db(\"<the name of your database here>\");` so that it matches the name of your database.\n\nLet's go over a few notes here. To be clear, this is mostly to show you how to connect to MongoDB from code and to show you that all those queries that you learned over the last section apply almost without modification (there are some small differences)\n\n- We grab a MongoDB connection string out of an environment variable (so you can do that if it's running on a server out in the cloud) otherwise it'll use a local running copy like we will right now.\n- You need to connect to the DB, then to a db (database), then to a collection.\n- You run all the queries at the collection level\n- find, sort, limit, toArray, deleteOne, findOneAndReplace, etc. all work the way you'd expect them to.\n\nThat's it! That's a quick Node.js server that connects to MongoDB!\n\n[samples]: https://github.com/btholt/db-samples\n","slug":"nodejs-app-with-mongodb","title":"Write a Node.js App with MongoDB","section":"Nosql","icon":"info-circle","filePath":"/home/runner/work/complete-intro-to-databases-v2/complete-intro-to-databases-v2/lessons/02-nosql/G-nodejs-app-with-mongodb.md","nextSlug":"/lessons/nosql/mongodb-ops","prevSlug":"/lessons/nosql/aggregation"}},"__N_SSG":true}