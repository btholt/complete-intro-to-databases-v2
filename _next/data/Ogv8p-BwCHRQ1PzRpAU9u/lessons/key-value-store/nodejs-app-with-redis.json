{"pageProps":{"post":{"attributes":{"title":"Node.js App with Redis","description":"Take the learnings from how to use Redis as a key-value store and cache from the command line to code! Brian whips up two examples of how and why you'd want to use Redis with Node.js."},"html":"<p>Let&#39;s quickly write up a quick Node.js project to help you transfer your skills from the command line to the coding world.</p>\n<p><a href=\"https://github.com/btholt/db-samples\">You can access all samples for this project here</a>.</p>\n<p>Make a new directory. In that directory run:</p>\n<pre><code class=\"hljs language-bash\">npm init -y\nnpm i express redis@3.0.2 express@4.17.1\n<span class=\"hljs-built_in\">mkdir</span> static\n<span class=\"hljs-built_in\">touch</span> static/index.html server.js\ncode . <span class=\"hljs-comment\"># or open this folder in VS Code or whatever editor you want</span>\n</code></pre><p>Let&#39;s make a dumb front end that just makes search queries against the backend. In static/index.html put:</p>\n<pre><code class=\"hljs language-html\"><span class=\"hljs-meta\">&lt;!DOCTYPE <span class=\"hljs-keyword\">html</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span> <span class=\"hljs-attr\">lang</span>=<span class=\"hljs-string\">&quot;en&quot;</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">meta</span> <span class=\"hljs-attr\">charset</span>=<span class=\"hljs-string\">&quot;UTF-8&quot;</span> /&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">meta</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">&quot;viewport&quot;</span> <span class=\"hljs-attr\">content</span>=<span class=\"hljs-string\">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span>Redis Sample<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">h1</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">&quot;visitors&quot;</span>&gt;</span>…<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">h1</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span>&gt;</span><span class=\"language-javascript\">\n      <span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">registerPageView</span>(<span class=\"hljs-params\"></span>) {\n        <span class=\"hljs-keyword\">const</span> res = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">fetch</span>(<span class=\"hljs-string\">&quot;/pageview&quot;</span>);\n        <span class=\"hljs-keyword\">const</span> { views } = <span class=\"hljs-keyword\">await</span> res.<span class=\"hljs-title function_\">json</span>();\n        <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">getElementById</span>(<span class=\"hljs-string\">&quot;visitors&quot;</span>).<span class=\"hljs-property\">innerText</span> = <span class=\"hljs-string\">`<span class=\"hljs-subst\">${views}</span> visitors!`</span>;\n      }\n      <span class=\"hljs-title function_\">registerPageView</span>();\n    </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span>\n</code></pre><p>Then let&#39;s make a server.js. Put this in there</p>\n<pre><code class=\"hljs language-javascript\"><span class=\"hljs-keyword\">const</span> { promisify } = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&quot;util&quot;</span>);\n<span class=\"hljs-keyword\">const</span> express = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&quot;express&quot;</span>);\n<span class=\"hljs-keyword\">const</span> redis = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&quot;redis&quot;</span>);\n<span class=\"hljs-keyword\">const</span> client = redis.<span class=\"hljs-title function_\">createClient</span>();\n\n<span class=\"hljs-keyword\">const</span> rIncr = <span class=\"hljs-title function_\">promisify</span>(client.<span class=\"hljs-property\">incr</span>).<span class=\"hljs-title function_\">bind</span>(client);\n\n<span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">init</span>(<span class=\"hljs-params\"></span>) {\n  <span class=\"hljs-keyword\">const</span> app = <span class=\"hljs-title function_\">express</span>();\n\n  app.<span class=\"hljs-title function_\">get</span>(<span class=\"hljs-string\">&quot;/pageview&quot;</span>, <span class=\"hljs-title function_\">async</span> (req, res) =&gt; {\n    <span class=\"hljs-keyword\">const</span> views = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">rIncr</span>(<span class=\"hljs-string\">&quot;pageviews&quot;</span>);\n\n    res.<span class=\"hljs-title function_\">json</span>({\n      <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">&quot;ok&quot;</span>,\n      views,\n    });\n  });\n\n  <span class=\"hljs-keyword\">const</span> <span class=\"hljs-variable constant_\">PORT</span> = process.<span class=\"hljs-property\">env</span>.<span class=\"hljs-property\">PORT</span> || <span class=\"hljs-number\">3000</span>;\n  app.<span class=\"hljs-title function_\">use</span>(express.<span class=\"hljs-title function_\">static</span>(<span class=\"hljs-string\">&quot;./static&quot;</span>));\n  app.<span class=\"hljs-title function_\">listen</span>(<span class=\"hljs-variable constant_\">PORT</span>);\n\n  <span class=\"hljs-variable language_\">console</span>.<span class=\"hljs-title function_\">log</span>(<span class=\"hljs-string\">`running on http://localhost:<span class=\"hljs-subst\">${PORT}</span>`</span>);\n}\n<span class=\"hljs-title function_\">init</span>();\n</code></pre><ul>\n<li>The Redis client for Node.js <em>still</em> doesn&#39;t support promises natively so we can use a function called <code>promisify</code> from the Node.js built in <code>utils</code> library to make it do promises. That&#39;s what <code>const rIncr = promisify(client.incr).bind(client);</code> does.</li>\n<li>From there it&#39;s really easy to just call an increment function from Redis.</li>\n</ul>\n<p>Okay let&#39;s add one more caching function to our app. In server.js add this</p>\n<pre><code class=\"hljs language-javascript\"><span class=\"hljs-comment\">// under rIncr</span>\n<span class=\"hljs-keyword\">const</span> rGet = <span class=\"hljs-title function_\">promisify</span>(client.<span class=\"hljs-property\">get</span>).<span class=\"hljs-title function_\">bind</span>(client);\n<span class=\"hljs-keyword\">const</span> rSetex = <span class=\"hljs-title function_\">promisify</span>(client.<span class=\"hljs-property\">setex</span>).<span class=\"hljs-title function_\">bind</span>(client);\n\n<span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">cache</span>(<span class=\"hljs-params\">key, ttl, slowFn</span>) {\n  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">...props</span>) {\n    <span class=\"hljs-keyword\">const</span> cachedResponse = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">rGet</span>(key);\n    <span class=\"hljs-keyword\">if</span> (cachedResponse) {\n      <span class=\"hljs-keyword\">return</span> cachedResponse;\n    }\n    <span class=\"hljs-keyword\">const</span> result = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">slowFn</span>(...props);\n    <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">rSetex</span>(key, ttl, result);\n    <span class=\"hljs-keyword\">return</span> result;\n  };\n}\n\n<span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">verySlowAndExpensiveFunction</span>(<span class=\"hljs-params\"></span>) {\n  <span class=\"hljs-comment\">// imagine this is like a really big join on PostgreSQL</span>\n  <span class=\"hljs-comment\">// or a call to an expensive API</span>\n\n  <span class=\"hljs-variable language_\">console</span>.<span class=\"hljs-title function_\">log</span>(<span class=\"hljs-string\">&quot;oh no an expensive call!&quot;</span>);\n  <span class=\"hljs-keyword\">const</span> p = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve</span>) =&gt;</span> {\n    <span class=\"hljs-built_in\">setTimeout</span>(<span class=\"hljs-function\">() =&gt;</span> {\n      <span class=\"hljs-title function_\">resolve</span>(<span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Date</span>().<span class=\"hljs-title function_\">toUTCString</span>());\n    }, <span class=\"hljs-number\">5000</span>);\n  });\n\n  <span class=\"hljs-keyword\">return</span> p;\n}\n\n<span class=\"hljs-keyword\">const</span> cachedFn = <span class=\"hljs-title function_\">cache</span>(<span class=\"hljs-string\">&quot;expensive_call&quot;</span>, <span class=\"hljs-number\">10</span>, verySlowAndExpensiveFunction);\n\n<span class=\"hljs-comment\">// inside init, under app.get pageviews</span>\napp.<span class=\"hljs-title function_\">get</span>(<span class=\"hljs-string\">&quot;/get&quot;</span>, <span class=\"hljs-title function_\">async</span> (req, res) =&gt; {\n  <span class=\"hljs-keyword\">const</span> data = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">cachedFn</span>();\n\n  res.<span class=\"hljs-title function_\">json</span>({\n    data,\n    <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">&quot;ok&quot;</span>,\n  });\n});\n</code></pre><ul>\n<li>This is a bit contrived example. Normally these would be separated amongst a bunch of files.</li>\n<li>Imagine our <code>verySlowAndExpensiveFunction</code> is something we&#39;re trying to call as infrequently as possible. In this case we&#39;re just having it wait and then resolve a promise but imagine it was an expensive database query or a call to an expensive-to-call API endpoint</li>\n<li><code>cache</code> is a generic caching function. With this you could cache anything. All it does is take in a redis key, how long to cache it, and some function to call when it doesn&#39;t find the item in the cache. It returns a function that makes it seamless to the call point: either it will immediately give you back what&#39;s in the cache or it will make you wait for the result of the <code>verySlowAndExpensiveFunction</code>.</li>\n<li>This definitely has thundering herd potential. What would be better is to have a second lock key that says &quot;hey, we&#39;re already trying to calculate/retrieve this answer.&quot; Then you can either have the backend poll that key for an answer or you could return a 503 to the frontend and have a frontend that will poll until the 503 clears. Lots of ways to handle this.</li>\n</ul>\n<p>There are lots of ways to use Redis in code and this just two. In summary though you will primarily use it for caching and non-mission critical, high-throughput data like telemetry.</p>\n","markdown":"\nLet's quickly write up a quick Node.js project to help you transfer your skills from the command line to the coding world.\n\n[You can access all samples for this project here][samples].\n\nMake a new directory. In that directory run:\n\n```bash\nnpm init -y\nnpm i express redis@3.0.2 express@4.17.1\nmkdir static\ntouch static/index.html server.js\ncode . # or open this folder in VS Code or whatever editor you want\n```\n\nLet's make a dumb front end that just makes search queries against the backend. In static/index.html put:\n\n```html\n<!DOCTYPE html>\n<html lang=\"en\">\n  <head>\n    <meta charset=\"UTF-8\" />\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />\n    <title>Redis Sample</title>\n  </head>\n  <body>\n    <h1 id=\"visitors\">…</h1>\n    <script>\n      async function registerPageView() {\n        const res = await fetch(\"/pageview\");\n        const { views } = await res.json();\n        document.getElementById(\"visitors\").innerText = `${views} visitors!`;\n      }\n      registerPageView();\n    </script>\n  </body>\n</html>\n```\n\nThen let's make a server.js. Put this in there\n\n```javascript\nconst { promisify } = require(\"util\");\nconst express = require(\"express\");\nconst redis = require(\"redis\");\nconst client = redis.createClient();\n\nconst rIncr = promisify(client.incr).bind(client);\n\nasync function init() {\n  const app = express();\n\n  app.get(\"/pageview\", async (req, res) => {\n    const views = await rIncr(\"pageviews\");\n\n    res.json({\n      status: \"ok\",\n      views,\n    });\n  });\n\n  const PORT = process.env.PORT || 3000;\n  app.use(express.static(\"./static\"));\n  app.listen(PORT);\n\n  console.log(`running on http://localhost:${PORT}`);\n}\ninit();\n```\n\n- The Redis client for Node.js _still_ doesn't support promises natively so we can use a function called `promisify` from the Node.js built in `utils` library to make it do promises. That's what `const rIncr = promisify(client.incr).bind(client);` does.\n- From there it's really easy to just call an increment function from Redis.\n\nOkay let's add one more caching function to our app. In server.js add this\n\n```javascript\n// under rIncr\nconst rGet = promisify(client.get).bind(client);\nconst rSetex = promisify(client.setex).bind(client);\n\nfunction cache(key, ttl, slowFn) {\n  return async function (...props) {\n    const cachedResponse = await rGet(key);\n    if (cachedResponse) {\n      return cachedResponse;\n    }\n    const result = await slowFn(...props);\n    await rSetex(key, ttl, result);\n    return result;\n  };\n}\n\nasync function verySlowAndExpensiveFunction() {\n  // imagine this is like a really big join on PostgreSQL\n  // or a call to an expensive API\n\n  console.log(\"oh no an expensive call!\");\n  const p = new Promise((resolve) => {\n    setTimeout(() => {\n      resolve(new Date().toUTCString());\n    }, 5000);\n  });\n\n  return p;\n}\n\nconst cachedFn = cache(\"expensive_call\", 10, verySlowAndExpensiveFunction);\n\n// inside init, under app.get pageviews\napp.get(\"/get\", async (req, res) => {\n  const data = await cachedFn();\n\n  res.json({\n    data,\n    status: \"ok\",\n  });\n});\n```\n\n- This is a bit contrived example. Normally these would be separated amongst a bunch of files.\n- Imagine our `verySlowAndExpensiveFunction` is something we're trying to call as infrequently as possible. In this case we're just having it wait and then resolve a promise but imagine it was an expensive database query or a call to an expensive-to-call API endpoint\n- `cache` is a generic caching function. With this you could cache anything. All it does is take in a redis key, how long to cache it, and some function to call when it doesn't find the item in the cache. It returns a function that makes it seamless to the call point: either it will immediately give you back what's in the cache or it will make you wait for the result of the `verySlowAndExpensiveFunction`.\n- This definitely has thundering herd potential. What would be better is to have a second lock key that says \"hey, we're already trying to calculate/retrieve this answer.\" Then you can either have the backend poll that key for an answer or you could return a 503 to the frontend and have a frontend that will poll until the 503 clears. Lots of ways to handle this.\n\nThere are lots of ways to use Redis in code and this just two. In summary though you will primarily use it for caching and non-mission critical, high-throughput data like telemetry.\n\n[samples]: https://github.com/btholt/db-samples\n","slug":"nodejs-app-with-redis","title":"Node.js App with Redis","section":"Key Value Store","icon":"info-circle","filePath":"/home/runner/work/complete-intro-to-databases-v2/complete-intro-to-databases-v2/lessons/05-key-value-store/F-nodejs-app-with-redis.md","nextSlug":"/lessons/key-value-store/redis-ops","prevSlug":"/lessons/key-value-store/more-redis-concepts"}},"__N_SSG":true}