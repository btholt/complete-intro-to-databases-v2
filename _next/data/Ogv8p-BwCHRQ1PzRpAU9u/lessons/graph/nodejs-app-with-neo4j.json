{"pageProps":{"post":{"attributes":{"title":"Node.js App with Neo4j","description":"Time to put some of that graph magic into practice! Put together with Brian an app to find the smallest path between two people in a graph."},"html":"<p>Let&#39;s quickly write up a quick Node.js project to help you transfer your skills from the command line to the coding world.</p>\n<p><a href=\"https://github.com/btholt/db-samples\">You can access all samples for this project here</a>.</p>\n<p>Make a new directory. In that directory run:</p>\n<pre><code class=\"hljs language-bash\">npm init -y\nnpm i express neo4j-driver@4.1.2 express@4.17.1\n<span class=\"hljs-built_in\">mkdir</span> static\n<span class=\"hljs-built_in\">touch</span> static/index.html server.js\ncode . <span class=\"hljs-comment\"># or open this folder in VS Code or whatever editor you want</span>\n</code></pre><p>Let&#39;s make a dumb front end that just makes search queries against the backend. In static/index.html put:</p>\n<pre><code class=\"hljs language-html\"><span class=\"hljs-meta\">&lt;!DOCTYPE <span class=\"hljs-keyword\">html</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span> <span class=\"hljs-attr\">lang</span>=<span class=\"hljs-string\">&quot;en&quot;</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">meta</span> <span class=\"hljs-attr\">charset</span>=<span class=\"hljs-string\">&quot;UTF-8&quot;</span> /&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">meta</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">&quot;viewport&quot;</span> <span class=\"hljs-attr\">content</span>=<span class=\"hljs-string\">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span>Neo4j Sample<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">input</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">&quot;text&quot;</span> <span class=\"hljs-attr\">placeholder</span>=<span class=\"hljs-string\">&quot;Person 1&quot;</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">&quot;person1&quot;</span> /&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">input</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">&quot;text&quot;</span> <span class=\"hljs-attr\">placeholder</span>=<span class=\"hljs-string\">&quot;Person 2&quot;</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">&quot;person2&quot;</span> /&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">button</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">&quot;btn&quot;</span>&gt;</span>Search<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">button</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">pre</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">code</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">&quot;code&quot;</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">code</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">pre</span>&gt;</span>\n\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span>&gt;</span><span class=\"language-javascript\">\n      <span class=\"hljs-keyword\">const</span> btn = <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">getElementById</span>(<span class=\"hljs-string\">&quot;btn&quot;</span>);\n      <span class=\"hljs-keyword\">const</span> code = <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">getElementById</span>(<span class=\"hljs-string\">&quot;code&quot;</span>);\n      <span class=\"hljs-keyword\">const</span> person1 = <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">getElementById</span>(<span class=\"hljs-string\">&quot;person1&quot;</span>);\n      <span class=\"hljs-keyword\">const</span> person2 = <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">getElementById</span>(<span class=\"hljs-string\">&quot;person2&quot;</span>);\n\n      btn.<span class=\"hljs-title function_\">addEventListener</span>(<span class=\"hljs-string\">&quot;click&quot;</span>, <span class=\"hljs-title function_\">async</span> () =&gt; {\n        code.<span class=\"hljs-property\">innerText</span> = <span class=\"hljs-string\">&quot;loading&quot;</span>;\n\n        <span class=\"hljs-keyword\">const</span> res = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">fetch</span>(\n          <span class=\"hljs-string\">`/get?person1=<span class=\"hljs-subst\">${<span class=\"hljs-built_in\">encodeURIComponent</span>(\n            person1.value\n          )}</span>&amp;person2=<span class=\"hljs-subst\">${<span class=\"hljs-built_in\">encodeURIComponent</span>(person2.value)}</span>`</span>\n        );\n        <span class=\"hljs-keyword\">const</span> json = <span class=\"hljs-keyword\">await</span> res.<span class=\"hljs-title function_\">json</span>();\n\n        code.<span class=\"hljs-property\">innerText</span> = <span class=\"hljs-string\">&quot;\\n&quot;</span> + <span class=\"hljs-title class_\">JSON</span>.<span class=\"hljs-title function_\">stringify</span>(json, <span class=\"hljs-literal\">null</span>, <span class=\"hljs-number\">4</span>);\n      });\n    </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span>\n</code></pre><ul>\n<li>Normally I&#39;d say don&#39;t put a big script tag in there but we&#39;re going for simplicity right now. You can refactor this later to something better.</li>\n<li>It&#39;d be way better if we had a dropdown of all actors, actresses, and directors in the graph instead of freeform text. I&#39;ll leave you to make that query and update the UI.</li>\n</ul>\n<p>In server.js, put this:</p>\n<pre><code class=\"hljs language-javascript\"><span class=\"hljs-keyword\">const</span> express = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&quot;express&quot;</span>);\n<span class=\"hljs-keyword\">const</span> neo4j = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&quot;neo4j-driver&quot;</span>);\n\n<span class=\"hljs-keyword\">const</span> <span class=\"hljs-variable constant_\">CONNECTION_STRING</span> =\n  process.<span class=\"hljs-property\">env</span>.<span class=\"hljs-property\">NEO4J_CONNECTION_STRING</span> || <span class=\"hljs-string\">&quot;bolt://localhost:7687&quot;</span>;\n\n<span class=\"hljs-keyword\">const</span> driver = neo4j.<span class=\"hljs-title function_\">driver</span>(<span class=\"hljs-title class_\">NEO4J</span>_CONNECTION_STRING);\n\n<span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">init</span>(<span class=\"hljs-params\"></span>) {\n  <span class=\"hljs-keyword\">const</span> app = <span class=\"hljs-title function_\">express</span>();\n\n  app.<span class=\"hljs-title function_\">get</span>(<span class=\"hljs-string\">&quot;/get&quot;</span>, <span class=\"hljs-title function_\">async</span> (req, res) =&gt; {\n    <span class=\"hljs-keyword\">const</span> session = driver.<span class=\"hljs-title function_\">session</span>();\n    <span class=\"hljs-keyword\">const</span> result = <span class=\"hljs-keyword\">await</span> session.<span class=\"hljs-title function_\">run</span>(\n      <span class=\"hljs-string\">`\n        MATCH path = shortestPath(\n            (First:Person {name: $person1 })-[*]-(Second:Person {name: $person2 })\n        )\n        UNWIND nodes(path) as node\n        RETURN coalesce(node.name, node.title) as text;\n    `</span>,\n      {\n        <span class=\"hljs-attr\">person1</span>: req.<span class=\"hljs-property\">query</span>.<span class=\"hljs-property\">person1</span>,\n        <span class=\"hljs-attr\">person2</span>: req.<span class=\"hljs-property\">query</span>.<span class=\"hljs-property\">person2</span>,\n      }\n    );\n\n    res.<span class=\"hljs-title function_\">json</span>({\n      <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">&quot;ok&quot;</span>,\n      <span class=\"hljs-attr\">path</span>: result.<span class=\"hljs-property\">records</span>.<span class=\"hljs-title function_\">map</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">record</span>) =&gt;</span> record.<span class=\"hljs-title function_\">get</span>(<span class=\"hljs-string\">&quot;text&quot;</span>)),\n    });\n\n    <span class=\"hljs-keyword\">await</span> session.<span class=\"hljs-title function_\">close</span>();\n  });\n\n  app.<span class=\"hljs-title function_\">use</span>(express.<span class=\"hljs-title function_\">static</span>(<span class=\"hljs-string\">&quot;./static&quot;</span>));\n  app.<span class=\"hljs-title function_\">listen</span>(process.<span class=\"hljs-property\">env</span>.<span class=\"hljs-property\">PORT</span> || <span class=\"hljs-number\">3000</span>);\n}\n<span class=\"hljs-title function_\">init</span>();\n</code></pre><ul>\n<li>Neo4j has its own transfer protocol (as opposed to HTTP) called bolt. Both PostgreSQL and MongoDB have their own too.</li>\n<li>Like PostgreSQL&#39;s pools, Neo4j&#39;s driver does that for you and gives you a client via a session. Make sure you close sessions when you&#39;re done so connections can be reused.</li>\n<li>We&#39;re doing a parameterized query just like PostgreSQL. As you can see you&#39;re sending a string to Neo4j which is the interpreting that string as a command. Any time this is happening you could suffer an injection attack. Luckily you can do the same thing here with a parameterized query so the driver ensures nothing bad can be injected.</li>\n<li>This is basically the Kevin Bacon query but generalized to be any two people.</li>\n<li>Neo4j gives you back a list of Record objects and you have to call <code>get()</code> on each of the records to get the attributes you want which is what we did with the map statement to get each of the names and titles.</li>\n</ul>\n","markdown":"\nLet's quickly write up a quick Node.js project to help you transfer your skills from the command line to the coding world.\n\n[You can access all samples for this project here][samples].\n\nMake a new directory. In that directory run:\n\n```bash\nnpm init -y\nnpm i express neo4j-driver@4.1.2 express@4.17.1\nmkdir static\ntouch static/index.html server.js\ncode . # or open this folder in VS Code or whatever editor you want\n```\n\nLet's make a dumb front end that just makes search queries against the backend. In static/index.html put:\n\n```html\n<!DOCTYPE html>\n<html lang=\"en\">\n  <head>\n    <meta charset=\"UTF-8\" />\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />\n    <title>Neo4j Sample</title>\n  </head>\n  <body>\n    <input type=\"text\" placeholder=\"Person 1\" id=\"person1\" />\n    <input type=\"text\" placeholder=\"Person 2\" id=\"person2\" />\n    <button id=\"btn\">Search</button>\n    <pre>\n        <code id=\"code\"></code>\n    </pre>\n\n    <script>\n      const btn = document.getElementById(\"btn\");\n      const code = document.getElementById(\"code\");\n      const person1 = document.getElementById(\"person1\");\n      const person2 = document.getElementById(\"person2\");\n\n      btn.addEventListener(\"click\", async () => {\n        code.innerText = \"loading\";\n\n        const res = await fetch(\n          `/get?person1=${encodeURIComponent(\n            person1.value\n          )}&person2=${encodeURIComponent(person2.value)}`\n        );\n        const json = await res.json();\n\n        code.innerText = \"\\n\" + JSON.stringify(json, null, 4);\n      });\n    </script>\n  </body>\n</html>\n```\n\n- Normally I'd say don't put a big script tag in there but we're going for simplicity right now. You can refactor this later to something better.\n- It'd be way better if we had a dropdown of all actors, actresses, and directors in the graph instead of freeform text. I'll leave you to make that query and update the UI.\n\nIn server.js, put this:\n\n```javascript\nconst express = require(\"express\");\nconst neo4j = require(\"neo4j-driver\");\n\nconst CONNECTION_STRING =\n  process.env.NEO4J_CONNECTION_STRING || \"bolt://localhost:7687\";\n\nconst driver = neo4j.driver(NEO4J_CONNECTION_STRING);\n\nasync function init() {\n  const app = express();\n\n  app.get(\"/get\", async (req, res) => {\n    const session = driver.session();\n    const result = await session.run(\n      `\n        MATCH path = shortestPath(\n            (First:Person {name: $person1 })-[*]-(Second:Person {name: $person2 })\n        )\n        UNWIND nodes(path) as node\n        RETURN coalesce(node.name, node.title) as text;\n    `,\n      {\n        person1: req.query.person1,\n        person2: req.query.person2,\n      }\n    );\n\n    res.json({\n      status: \"ok\",\n      path: result.records.map((record) => record.get(\"text\")),\n    });\n\n    await session.close();\n  });\n\n  app.use(express.static(\"./static\"));\n  app.listen(process.env.PORT || 3000);\n}\ninit();\n```\n\n- Neo4j has its own transfer protocol (as opposed to HTTP) called bolt. Both PostgreSQL and MongoDB have their own too.\n- Like PostgreSQL's pools, Neo4j's driver does that for you and gives you a client via a session. Make sure you close sessions when you're done so connections can be reused.\n- We're doing a parameterized query just like PostgreSQL. As you can see you're sending a string to Neo4j which is the interpreting that string as a command. Any time this is happening you could suffer an injection attack. Luckily you can do the same thing here with a parameterized query so the driver ensures nothing bad can be injected.\n- This is basically the Kevin Bacon query but generalized to be any two people.\n- Neo4j gives you back a list of Record objects and you have to call `get()` on each of the records to get the attributes you want which is what we did with the map statement to get each of the names and titles.\n\n[samples]: https://github.com/btholt/db-samples\n","slug":"nodejs-app-with-neo4j","title":"Node.js App with Neo4j","section":"Graph","icon":"info-circle","filePath":"/home/runner/work/complete-intro-to-databases-v2/complete-intro-to-databases-v2/lessons/04-graph/F-nodejs-app-with-neo4j.md","nextSlug":"/lessons/graph/neo4j-ops","prevSlug":"/lessons/graph/indexes-in-neo4j"}},"__N_SSG":true}